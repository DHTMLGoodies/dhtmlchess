// (C) dhtmlchess.com, Alf Kalleland 2017-04-10 21:41:25
/*
 * Copyright Â©2017. dhtmlchess.com. All Rights Reserved.
 * This is a commercial software. See dhtmlchess.com for licensing options.
 *
 * You are free to use/try this software for 30 days without paying any fees.
 *
 * IN NO EVENT SHALL DHTML CHESS BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL,
 * OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS, ARISING OUT OF THE USE OF THIS SOFTWARE AND
 * ITS DOCUMENTATION, EVEN IF DHTML CHESS HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * DHTML CHESS SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 * THE SOFTWARE AND ACCOMPANYING DOCUMENTATION, IF ANY, PROVIDED HEREUNDER IS PROVIDED "AS IS".
 * DHTML CHESS HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 *
 */
 chess.WPTemplate=new Class({Extends:Events,renderTo:undefined,module:undefined,_ready:true,_loadCounter:0,th:undefined,themeObject:undefined,controller:undefined,heading_tpl:undefined,wpm_h:20,nav:true,sound:false,boardId:undefined,_p:false,compToggle:false,pgn:undefined,pgnAll:undefined,arrowSolution:undefined,board:undefined,arrow:undefined,hint:undefined,dr:undefined,url:undefined,lp:undefined,initialize:function(a){if(a.docRoot){ludo.config.setDocumentRoot(a.docRoot)}this.lp=ludo.isMobile?"inside":"outside";this.dr=ludo.config.getDocumentRoot();this.url=ludo.config.getUrl();this.renderTo=jQuery(a.renderTo);this.module=String.uniqueID();this.boardId="dhtml_chess"+String.uniqueID();this.board=a.board||{};this.arrow=a.arrow||{};this.arrowSolution=a.arrowSolution||{};this.hint=a.hint||{};if(a.pgn!=undefined){if(jQuery.isArray(a.pgn)){this.pgn=a.pgn[0];this.pgnAll=a.pgn}else{this.pgn=a.pgn;this.pgnAll=[a.pgn]}}if(a.comp_toggle){this.compToggle=a.comp_toggle}if(a._p!=undefined){this._p=a._p}if(this._p){this.wpm_h=0}this.themeObject=chess.THEME;this.th=a.theme||a.defaultTheme;this.th="dc-"+this.th;if(a.sound!=undefined){this.sound=a.sound}if(a.heading_tpl!=undefined){this.heading_tpl=a.heading_tpl}if(a.css){var d=a.css.split(/;/g);jQuery.each(d,function(f,g){if(g){var e=g.split(/:/);this.renderTo.css(e[0],e[1])}}.bind(this))}if(!ludo.isMobile){if(a.width){this.renderTo.css("width",a.width)}if(a["float"]){this.renderTo.css("float",a["float"])}}chess.THEME_OVERRIDES=undefined;var c=a.theme;if(c){this._ready=false;jQuery("<link/>",{rel:"stylesheet",type:"text/css",href:this.dr+"themes/"+c+".css",complete:function(){this.onload()}.bind(this)}).appendTo("head");jQuery.ajax({url:this.dr+"themes/"+c+".js",dataType:"script",complete:function(){this.onload()}.bind(this)})}if(this.nav){var b=ludo._new("chess.WPManager");b.add(this)}},adjustButtonArray:function(a){if(this.compToggle){a.push("comp")}},controllerType:function(){return this._p?"ComputerController":"Controller"},randomPgn:function(){var a=Math.floor(Math.random()*this.pgnAll.length);return this.pgnAll[a]},curModel:function(){return this.controller.currentModel},allPgnIdsString:function(){var a=[];jQuery.each(this.pgnAll,function(b,c){a.push(c.id)});return a.join("_")},isValidPgn:function(a){for(var b=0;b<this.pgnAll.length;b++){if(this.pgnAll[b].id==a){return true}}return false},onload:function(){this._loadCounter++;if(!this._ready&&this._loadCounter==2){this.render()}this._ready=this._loadCounter==2},canRender:function(){return this._ready},createController:function(){var a=this.controller;a.on("enginestatus",this.showEngineStatusDialog.bind(this));a.on("compGameOver",this.onGameOver.bind(this));a.on("comp",this.hideOverlays.bind(this))},hideOverlays:function(){if(this.game_over_div){this.game_over_div.hide()}},onGameOver:function(b){if(this.game_over_div==undefined){var c=this.game_over_div=jQuery('<div class="dhtml_chess_overlay_parent"><div class="dhtml_chess_overlay"></div><div class="dhtml_chess_game_over_text"></div></div>');ludo.$(this.boardId).boardEl().append(c)}var a=b==1?"1 - 0":b==-1?"0 - 1":"0.5 - 0.5";var d=this.game_over_div.height();this.game_over_div.find(".dhtml_chess_game_over_text").css("line-height",d+"px").css("font-size",Math.round(d/4)+"px").html(a);this.game_over_div.show()},showEngineStatusDialog:function(){var a=this.computerDialog();if(this.controller.engineLoaded()){a.hide()}else{a.show()}},cs_dialog:undefined,computerDialog:function(){if(this.cs_dialog==undefined){var a=jQuery('<div class="dhtml_chess_loading"><div class="dhtml_chess_overlay"></div><div class="dhtml_chess_centered_bg dhtml_chess_loading_image"></div></div>');ludo.$(this.boardId).boardEl().append(a);this.cs_dialog=a}return this.cs_dialog}});window.chess.isWordPress=true;chess.WPGameTemplate=new Class({Extends:chess.WPTemplate,fen:undefined,initialize:function(a){this.parent(a);this.model=a.model||undefined;this.gameId=a.gameId;if(a.fen){this.fen=a.fen}if(!this.model&&!this.gameId&&!this.fen){this.gameId=2}},createController:function(){this.controller=new chess.controller[this.controllerType()]({applyTo:[this.module],stockfish:ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js",sound:this.sound});if(this.fen){this.controller.setPosition(this.fen)}this.parent();this.loadGame()},loadGame:function(){if(this.gameId){jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:{action:"game_by_id",id:this.gameId},complete:function(c,a){this.controller.currentModel.afterLoad();if(a=="success"){var d=c.responseJSON;if(d.success){var b=d.response;this.controller.currentModel.populate(b)}}else{this.fireEvent("wperrror",chess.__("Could not load game. Try again later"))}}.bind(this),fail:function(b,a){this.fireEvent(a)}.bind(this)})}else{if(this.model){this.controller.currentModel.populate(this.model)}}}});chess.WPViewerTemplate=new Class({Extends:chess.WPTemplate,pgn:undefined,createController:function(){this.controller=new chess.controller[this.controllerType()]({applyTo:[this.module],sound:this.sound,pgn:this.pgn.id,stockfish:ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js",listeners:{}});
this.parent()},initialize:function(a){this.parent(a)}});window.chess.isWordPress=true;chess.WPGame1=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,buttonSize:45,initialize:function(b){this.parent(b);var a=this.renderTo.width();if(ludo.isMobile){this.renderTo.css({height:Math.ceil(a+this.wpm_h+40),position:"relative"});this.boardSize=a-200}else{this.renderTo.css({height:Math.ceil(a-200+45+35+this.wpm_h),position:"relative"});this.boardSize=a-200}this.buttons=["start","previous","play","next","end","flip"];this.adjustButtonArray(this.buttons);this.bs=this.boardSize>400?this.boardSize:a;if(this.canRender()){this.render()}},render:function(){this.board=Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board);new chess.view.Chess({renderTo:this.renderTo,cls:this.th,layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()});this.createController()},desktopChildren:function(){return[{layout:{height:35,width:ludo.isMobile?"matchParent":this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[this.board,{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Table",layout:{width:200},elCss:{"margin-left":"2px"},module:this.module}]},{css:{"margin-top":5},type:"chess.view.buttonbar.Bar",buttons:this.buttons,layout:{height:45,width:this.bs},module:this.module},{type:"chess.WPComMessage",hidden:this._p}]},mobileChildren:function(){return[this.board,{layout:{type:"linear",orientation:"horizontal",height:this.buttonSize},elCss:{"margin-top":10},children:[{weight:1},{anchor:[0.5,0.5],type:"chess.view.buttonbar.Bar",buttons:["start","previous"],module:this.module,layout:{width:(this.buttonSize)*3},buttonSize:function(a){return a*0.9}},{type:"chess.view.notation.LastMove",module:this.module,layout:{width:this.buttonSize*2},css:{border:"none"}},{anchor:[0.5,0.5],type:"chess.view.buttonbar.Bar",buttons:["next","end"],module:this.module,layout:{width:(this.buttonSize)*2},buttonSize:function(a){return a*0.9}},{weight:1}]},{type:"chess.WPComMessage",hidden:this._p}]}});chess.WPGame2=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,initialize:function(b){this.parent(b);var a=this.renderTo.width();this.renderTo.css("height",a+275+this.wpm_h);this.boardSize=a;this.buttons=["start","previous","play","next","end","flip"];this.adjustButtonArray(this.buttons);if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({renderTo:this.renderTo,cls:this.th,layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-size":"1em","font-weight":"bold"}},Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{type:"chess.view.buttonbar.Bar",buttons:this.buttons,elCss:{"padding-top":2},layout:{height:40,width:this.boardSize},module:this.module},{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Panel",layout:{height:200},elCss:{"margin-left":"2px"},module:this.module},{type:"chess.WPComMessage",hidden:this._p}]});this.createController()}});window.chess.isWordPress=true;chess.WPGame3=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,initialize:function(b){this.parent(b);var a=this.renderTo.width();if(ludo.isMobile){this.renderTo.css("height",a+275+this.wpm_h);this.boardSize=a}else{this.boardSize=a*2/3;this.renderTo.css("height",a-150+42+35+this.wpm_h)}this.board=Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:2,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board);this.lastButtons=["flip"];this.adjustButtonArray(this.lastButtons);if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({renderTo:this.renderTo,cls:this.th,layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()});this.createController()},mobileChildren:function(){return[{layout:{height:35},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-size":"1em","font-weight":"bold"}},this.board,{layout:{type:"linear",orientation:"horizontal",height:40,width:this.boardSize},css:{"margin-top":5},children:[{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["start","end"],width:85,buttonSize:function(a){return a
}},{weight:1},{type:"chess.view.notation.LastMove",width:80,module:this.module},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["play"],width:45,buttonSize:function(a){return a}}]},{css:{"margin-top":4},layout:{height:200},type:"chess.view.notation.LastComment",module:this.module},{type:"chess.WPComMessage",hidden:this._p}]},desktopChildren:function(){return[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-size":"1em","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[this.board,{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.LastComment",layout:{weight:1},elCss:{"margin-left":"2px"},module:this.module}]},{layout:{type:"linear",orientation:"horizontal",height:40,width:this.boardSize},css:{"margin-top":5},children:[{weight:1},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["start","previous"],width:85,buttonSize:function(a){return a}},{type:"chess.view.notation.LastMove",width:80,module:this.module},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["next","end"],width:85,buttonSize:function(a){return a}},{weight:1},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:this.lastButtons,width:42*this.lastButtons.length,buttonSize:function(a){return a}}]},{type:"chess.WPComMessage",hidden:this._p}]}});window.chess.isWordPress=true;chess.WPGame4=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,initialize:function(b){this.parent(b);var a=this.renderTo.width();this.renderTo.css("height",a+40+35+20);this.boardSize=a;this.lastButtons=["flip"];this.adjustButtonArray(this.lastButtons);if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({renderTo:this.renderTo,cls:this.th,layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-size":"1em","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board)]},{layout:{type:"linear",orientation:"horizontal",height:40,width:this.boardSize},css:{"margin-top":5},children:ludo.isMobile?[{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["play"],width:45,buttonSize:function(a){return a}},{type:"chess.view.notation.LastMove",weight:1,module:this.module},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["start","end","flip"],width:125,buttonSize:function(a){return a}}]:[{weight:1},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["start","previous"],width:85,buttonSize:function(a){return a}},{type:"chess.view.notation.LastMove",width:80,module:this.module},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:["next","end"],width:85,buttonSize:function(a){return a}},{weight:1},{type:"chess.view.buttonbar.Bar",module:this.module,buttons:this.lastButtons,width:42*this.lastButtons.length,buttonSize:function(a){return a}}]},{type:"chess.WPComMessage",hidden:this._p}]});this.createController()}});window.chess.isWordPress=true;chess.WPGame5=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,buttonSize:45,boardWeight:1,notationWeight:1,initialize:function(b){this.parent(b);var c=this.renderTo;var a=c.width();if(ludo.isMobile){this.notationWeight=0}this.boardSize=(a/(this.boardWeight+this.notationWeight));if(ludo.isMobile){c.css("height",a+275+this.wpm_h)}else{c.css("height",this.boardSize+this.buttonSize+this.wpm_h)}c.css("position","relative");this.buttons=ludo.isMobile?["start","previous","next","end"]:["start","previous","next","end","flip"];this.adjustButtonArray(this.buttons);this.configure();if(this.canRender()){this.render()}},configure:function(){this.board=Object.merge({boardLayout:undefined,vAlign:top,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg_bw",background:{borderRadius:0},boardCss:{border:0},labelPos:this.lp,layout:{weight:this.boardWeight,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board);chess.THEME_OVERRIDES={"chess.view.board.Board":{background:{borderRadius:"1%"}},"chess.view.buttonbar.Bar":{borderRadius:"10%",styles:{button:{"fill-opacity":0,"stroke-opacity":0},image:{fill:"#777"},buttonOver:{"fill-opacity":0,"stroke-opacity":0},imageOver:{fill:"#555"},buttonDown:{"fill-opacity":0,"stroke-opacity":0},imageDown:{fill:"#444"},buttonDisabled:{"fill-opacity":0,"stroke-opacity":0},imageDisabled:{fill:"#555","fill-opacity":0.3}}}}
},render:function(){new chess.view.Chess({renderTo:this.renderTo,cls:this.th,layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()});this.createController()},desktopChildren:function(){return[{layout:{height:this.boardSize,type:"linear",orientation:"horizontal"},children:ludo.isMobile?[this.board]:[this.board,{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Panel",layout:{weight:this.notationWeight,height:"matchParent"},elCss:{"margin-left":"2px"},module:this.module}]},{layout:{type:"linear",orientation:"horizontal",height:this.buttonSize},elCss:{"margin-top":10},children:[{weight:1},{anchor:[1,0.5],type:"chess.view.buttonbar.Bar",buttons:this.buttons,module:this.module,layout:{width:(this.buttonSize-10)*this.buttons.length},buttonSize:function(a){return a*0.9}}]},{type:"chess.WPComMessage",hidden:this._p}]},mobileChildren:function(){return[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","font-size":"1em","font-weight":"bold"}},Object.merge({boardLayout:undefined,id:"tactics_board",type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labels:!ludo.isMobile,labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{layout:{type:"linear",orientation:"horizontal",height:40,width:this.boardSize},children:[{type:"chess.view.buttonbar.Bar",layout:{height:40,weight:1},module:this.module}]},{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Panel",layout:{height:200},elCss:{"margin-left":"2px"},module:this.module},{type:"chess.WPComMessage",hidden:this._p}]}});window.chess.isWordPress=true;chess.WPGame6=new Class({Extends:chess.WPGameTemplate,boardSize:undefined,buttonSize:45,boardWeight:1,notationWeight:1,buttonHeight:35,initialize:function(b){this.parent(b);var a=this.renderTo.width();var c=this.comp?this.buttonHeight:0;this.renderTo.css("height",a+c+this.wpm_h);if(b.highlight!=undefined){this.highlight=b.highlight}if(b.arrows!=undefined){this.arrows=b.arrows}if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:this.renderTo,layout:{type:"linear",orientation:"vertical"},children:[{module:this.module,type:"chess.view.board.Board",id:this.boardId,fen:this.fen,sideToMove:false,labelPos:this.lp,layout:{width:"matchParent",weight:1}},{height:this.buttonHeight,hidden:!this.compToggle,module:this.module,type:"chess.view.buttonbar.Bar",buttons:["flip","comp"]},{type:"chess.WPComMessage",hidden:this._p}]});if(this.highlight!=undefined){var f=new chess.view.highlight.SquarePool({board:ludo.$(this.boardId)});var d=this.highlight.split(/\,/g);var c=undefined;jQuery.each(d,function(g,h){var j=h.split(/;/g);if(j.length>0){c=j[1]}f.show(j[0],c)})}if(this.arrows!=undefined){var e=new chess.view.highlight.ArrowPool({board:ludo.$(this.boardId)});var b=this.arrows.split(/,/g);var a;jQuery.each(b,function(h,k){var l=k.split(/;/g);if(l.length>1){if(a==undefined){a={}}a.fill=a.stroke=l[1]}var j=l[0].substr(0,2);var g=l[0].substr(2,2);e.show(j,g,a)})}this.createController()}});window.chess.isWordPress=true;chess.WPViewer1=new Class({Extends:chess.WPViewerTemplate,showLabels:undefined,boardSize:undefined,initialize:function(b){this.parent(b);var c=this.renderTo;var a=c.width();if(ludo.isMobile){this.boardSize=a;c.css("height",Math.round(this.boardSize+340+this.wpm_h))}else{this.boardSize=a-150;c.css("height",Math.round(this.boardSize+375+this.wpm_h))}this.lastButtons=["next","end"];this.adjustButtonArray(this.lastButtons);this.buttons=ludo.isMobile?["start","previous","next","end"]:["start","previous","next","end","flip"];this.adjustButtonArray(this.buttons);this.showLabels=!ludo.isMobile;if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()});this.createController()},desktopChildren:function(){return[{layout:{type:"linear",orientation:"vertical"},children:[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-size":"1em","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Table",layout:{width:150},elCss:{"margin-left":"2px"},module:this.module}]},{layout:{height:40,width:this.boardSize,type:"linear",orientation:"horizontal"},children:[{anchor:[0.5,1],type:"chess.view.buttonbar.Bar",buttons:this.buttons,module:this.module,layout:{height:"matchParent",width:(this.boardSize-40)},buttonSize:function(a){return a*0.9
}}]},{title:this.pgn.name,module:this.module,layout:{height:300},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},cols:["white","black","result"],dataSource:{id:"gameList",type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{select:function(){ludo.$(this.module+"-panel").show()}.bind(this),load:function(a){if(a.length){ludo.get("gameList").selectRecord(a[0])}}},shim:{txt:""}}},{type:"chess.WPComMessage",hidden:this._p}]}]},mobileChildren:function(){return[{layout:{type:"linear",orientation:"vertical"},children:[Object.merge({boardLayout:undefined,id:"tactics_board",type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labels:!ludo.isMobile,labelPos:this.lp,layout:{height:this.boardSize},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{layout:{height:40,type:"linear",orientation:"horizontal"},children:[{weight:1},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:90},module:this.module,buttons:["start","previous"],buttonSize:function(a){return a*0.9}},{type:"chess.view.notation.LastMove",module:this.module,layout:{width:70},css:{"padding-top":4,"padding-bottom":4,border:"none"}},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:45*this.lastButtons.length},module:this.module,buttons:this.lastButtons,buttonSize:function(a){return a*0.9}},{weight:1}]},{title:this.pgn.name,module:this.module,layout:{height:300},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},cols:["white","black","result"],dataSource:{id:"gameList",type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{load:function(a){if(a.length){ludo.get("gameList").selectRecord(a[0])}}},shim:{txt:""}}}]}]}});window.chess.isWordPress=true;chess.WPViewer2=new Class({Extends:chess.WPViewerTemplate,showLabels:undefined,boardSize:undefined,sofia:false,width:undefined,initialize:function(b){this.parent(b);var c=this.renderTo;var a=this.width=c.width();this.boardSize=ludo.isMobile?a:a/2;c.css("height",Math.round(this.boardSize+375+this.wpm_h));if(b.sofia){this.sofia=true}this.showLabels=!ludo.isMobile;this.buttons=ludo.isMobile?["start","previous","next","end"]:["start","previous","next","end","flip"];this.adjustButtonArray(this.buttons);this.gameListDsId="gamelist"+String.uniqueID();this.standingsId="standingsId"+String.uniqueID();if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:[{layout:{type:"linear",orientation:"vertical"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()}]});this.createController()},desktopChildren:function(){return[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Panel",layout:{weight:1},elCss:{"margin-left":"2px"},module:this.module}]},{layout:{height:40,type:"linear",orientation:"horizontal",width:"matchParent"},children:[{anchor:[1,0.5],type:"chess.view.buttonbar.Bar",buttons:this.buttons,module:this.module,layout:{height:"matchParent",width:this.width-40},buttonSize:function(a){return a*0.9}}]},{height:300,layout:{type:"tabs"},cls:"ludo-light-gray",css:{border:"1px solid #aeb0b0"},children:[{layout:{type:"linear",orientation:"vertical"},title:chess.__("Games"),children:[{module:this.module,layout:{weight:1},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},cols:["round","white","black","result"],dataSource:{id:this.gameListDsId,type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{select:function(){ludo.$(this.module+"-panel").show()}.bind(this),load:function(a){if(a.length){ludo.$(this.gameListDsId).selectRecord(a[0])}}.bind(this)},shim:{txt:""}}},{type:"form.Text",placeholder:chess.__("Search"),css:{"border-top":"1px solid #aeb0b0"},layout:{height:30},listeners:{key:function(a){this.search(a)}.bind(this)}}]},{id:this.standingsId,type:"chess.wordpress.PgnStandings",module:this.module,pgnId:this.pgn.id,layout:{weight:1},title:chess.__("Standings")}]},{type:"chess.WPComMessage",hidden:this._p}]},mobileChildren:function(){return[Object.merge({boardLayout:undefined,id:"tactics_board",type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labels:!ludo.isMobile,labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{layout:{height:40,type:"linear",orientation:"horizontal"},children:[{weight:1},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:90},module:this.module,buttons:["start","previous"],buttonSize:function(a){return a*0.9
}},{type:"chess.view.notation.LastMove",module:this.module,layout:{width:70},css:{"padding-top":4,"padding-bottom":4,border:"none"}},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:90},module:this.module,buttons:["next","end"],buttonSize:function(a){return a*0.9}},{weight:1}]},{height:300,layout:{type:"tabs"},cls:"ludo-light-gray",css:{border:"1px solid #aeb0b0"},children:[{layout:{type:"linear",orientation:"vertical"},title:chess.__("Games"),children:[{module:this.module,layout:{weight:1},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},keys:["white","black","result"],dataSource:{id:this.gameListDsId,type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{load:function(a){if(a.length){ludo.$(this.gameListDsId).selectRecord(a[0])}}.bind(this)},shim:{txt:""}}},{type:"form.Text",placeholder:chess.__("Search"),css:{"border-top":"1px solid #aeb0b0"},layout:{height:30},listeners:{key:function(a){this.search(a)}.bind(this)}}]},{id:this.standingsId,type:"chess.wordpress.PgnStandings",module:this.module,sofiaRules:this.sofia,pgnId:this.pgn.id,keys:["player","score"],layout:{weight:1},title:chess.__("Standings")}]},{type:"chess.WPComMessage",hidden:this._p}]},search:function(a){ludo.$(this.gameListDsId).search(a)}});window.chess.isWordPress=true;chess.WPViewer3=new Class({Extends:chess.WPViewerTemplate,showLabels:undefined,boardSize:undefined,initialize:function(b){this.parent(b);this.renderTo=b.renderTo;var c=jQuery(this.renderTo);var a=c.width();if(ludo.isMobile){this.boardSize=a;c.css("height",Math.round(this.boardSize+340+this.wpm_h))}else{this.boardSize=a/2;c.css("height",Math.round(this.boardSize+375+this.wpm_h))}this.buttons=ludo.isMobile?["start","previous","next","end"]:["start","previous","next","end","flip"];this.adjustButtonArray(this.buttons);this.showLabels=!ludo.isMobile;if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:ludo.isMobile?this.mobileChildren():this.desktopChildren()});this.createController()},desktopChildren:function(){return[{layout:{type:"linear",orientation:"vertical"},children:[{layout:{height:35,width:this.boardSize},module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"{white} - {black}",cls:"metadata",css:{"text-align":"center","font-size":"1em","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal",height:this.boardSize},children:[Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labels:!ludo.isMobile,labelPos:this.lp,layout:{weight:1,height:"wrap"},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{id:this.module+"-panel",name:"notation-panel",type:"chess.view.notation.Panel",layout:{weight:1},elCss:{"margin-left":"2px"},module:this.module}]},{layout:{height:40,type:"linear",orientation:"horizontal"},children:[{anchor:[1,0.5],type:"chess.view.buttonbar.Bar",buttons:this.buttons,module:this.module,layout:{height:"matchParent",weight:1},buttonSize:function(a){return a*0.9}}]},{title:this.pgn.name,module:this.module,layout:{height:300},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},cols:["white","black","result"],dataSource:{id:"gameList",type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{select:function(){ludo.$(this.module+"-panel").show()}.bind(this),load:function(a){if(a.length){ludo.get("gameList").selectRecord(a[0])}}},shim:{txt:""}}},{type:"chess.WPComMessage",hidden:this._p}]}]},mobileChildren:function(){return[{layout:{type:"linear",orientation:"vertical"},children:[Object.merge({boardLayout:undefined,id:"tactics_board",type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{height:this.boardSize},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow)]},this.board),{layout:{height:40,type:"linear",orientation:"horizontal"},children:[{weight:1},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:90},module:this.module,buttons:["start","previous"],buttonSize:function(a){return a*0.9}},{type:"chess.view.notation.LastMove",module:this.module,layout:{width:70},css:{"padding-top":4,"padding-bottom":4,border:"none"}},{type:"chess.view.buttonbar.Bar",layout:{height:40,width:90},module:this.module,buttons:["next","end"],buttonSize:function(a){return a*0.9}},{weight:1}]},{title:this.pgn.name,module:this.module,layout:{height:300},type:"chess.WPGameGrid",css:{"overflow-y":"auto"},cols:["white","black","result"],dataSource:{id:"gameList",type:"chess.wordpress.GameList",module:this.module,autoload:true,postData:{pgn:this.pgn.id},listeners:{load:function(a){if(a.length){ludo.get("gameList").selectRecord(a[0])}}},shim:{txt:""}}}]}]}});chess.WPGameGrid=new Class({Extends:chess.view.gamelist.Grid,headerMenu:false,dataSource:{type:"ludo.dataSource.JSONArray",autoload:false,postData:{action:"list_of_games"}},emptyText:chess.__("No games"),loadMessage:chess.__("Loading games..."),cols:["white","black","round","result","last_moves"],__construct:function(a){this.cols=a.cols||this.cols;
this.parent(a)},loadGames:function(){if(this.getDataSource().postData.pgn){this.load()}},selectGame:function(a){this.fireEvent("selectGame",[a,this.getDataSource().postData.pgn])}});chess.WPManager=new Class({Extends:ludo.Core,type:"chess.WPManager",singleton:true,views:undefined,activeView:undefined,__construct:function(a){this.parent(a);this.views=[];this.addKeyEvents()},add:function(a){this.views.push(a);var b=function(){this.activeView=a}.bind(this);a.renderTo.on("click",b)},addKeyEvents:function(){jQuery(document).keydown(function(a){if(this.activeView){var b=this.activeView.controller;if(a.key=="ArrowRight"){b.currentModel.nextMove();return false}else{if(a.key=="ArrowLeft"){b.currentModel.previousMove();return false}}}}.bind(this))}});ludo.factory.createAlias("chess.WPManager",chess.WPManager);chess.WPComMessage=new Class({Extends:ludo.View,css:{"font-size":"12px","line-height":"20px","text-align":"right","padding-right":4},layout:{height:20},_html:'Powered by <a href="https://wordpresschess.com">WordPressChess.com</a>'});window.chess.isWordPress=true;chess.WPTactics1=new Class({Extends:chess.WPTemplate,renderTo:undefined,pgn:undefined,controller:undefined,showLabels:undefined,module:undefined,boardSize:undefined,random:false,nav:false,history:undefined,historySize:20,historyKey:undefined,historyIndexKey:undefined,historyIndex:0,loadedFromHistory:false,previousButtonId:undefined,initialize:function(b){this.parent(b);var c=jQuery(this.renderTo);var a=c.width();c.css("height",Math.round(a+130+this.wpm_h));this.boardSize=a;if(b.random!=undefined){this.random=b.random}this.board=b.board||{};this.arrow=b.arrow||{};this.arrowSolution=b.arrowSolution||{};this.hint=b.hint||{};this.module=String.uniqueID();this.previousButtonId="dc-"+String.uniqueID();this.historyKey="tactics-history-"+this.pgn.id;this.historyIndexKey="tactics-history-index"+this.pgn.id;var d=ludo.getLocalStorage().get(this.historyKey,"");this.history=d.length>0?d.split(/,/g):[];this.historyIndex=ludo.getLocalStorage().get(this.historyIndexKey,0)/1;this.showLabels=!ludo.isMobile;if(this.renderTo.substr&&this.renderTo.substr(0,1)!="#"){this.renderTo="#"+this.renderTo}if(this.canRender()){this.render()}},previousGame:function(){this.loadedFromHistory=true;if(this.random){if(this.history.length>1&&this.historyIndex>0){this.historyIndex--;this.loadFromHistory()}}else{this.controller.loadPreviousGameFromFile(this.pgn)}},nextGame:function(){this.loadedFromHistory=false;if(this.random){if(this.historyIndex<this.history.length-1){this.historyIndex++;this.loadFromHistory()}else{this.controller.loadRandomGame()}}else{this.controller.loadNextGameFromFile()}},loadFromHistory:function(){this.loadedFromHistory=true;this.saveHistoryIndex();var a=this.history[this.historyIndex];this.controller.loadWordPressGameById(this.pgn.id,a)},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:[{layout:{type:"linear",orientation:"vertical"},children:[{height:35,module:this.module,type:"chess.view.metadata.Game",tpl:this.heading_tpl||"#{index} - {white}",cls:"metadata",css:{"text-align":"center","overflow-y":"auto","font-weight":"bold"}},{layout:{type:"linear",orientation:"horizontal"},css:{"margin-top":2},height:30,children:[{weight:1},{module:this.module,layout:{width:80},type:"chess.view.button.TacticHint",value:chess.__("Hint")},{module:this.module,layout:{width:80},type:"chess.view.button.TacticSolution",value:chess.__("Solution")},{module:this.module,layout:{width:80},type:"form.Button",value:chess.__("Next"),listeners:{click:this.nextGame.bind(this)}},{id:this.previousButtonId,module:this.module,layout:{width:80},type:"form.Button",value:chess.__("Previous"),listeners:{click:this.previousGame.bind(this)}},{weight:1}]},Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{height:this.boardSize},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow),Object.merge({type:"chess.view.highlight.ArrowTactic"},this.arrowSolution),Object.merge({type:"chess.view.highlight.SquareTacticHint"},this.hint)]},this.board),{height:50,module:this.module,comments:false,figurines:"svg_egg",type:"chess.view.notation.TacticPanel"},{type:"chess.WPComMessage",hidden:this._p}]}]});var b="wp_"+this.pgn.id+"_tactics";new chess.view.message.TacticsMessage({renderTo:jQuery(document.body),module:this.module,autoHideAfterMs:1000,hidden:true,autoHideWelcomeAfterMs:1000,css:{"background-color":"#fff","border-radius":"5px","line-height":"50px"},layout:{centerIn:this.boardId,width:300,height:50}});this.controller=new chess.controller.TacticControllerGui({applyTo:[this.module],pgn:this.pgn.id,sound:this.sound,autoMoveDelay:400,gameEndHandler:this.nextGame.bind(this),listeners:{loadGame:function(){var d=this.controller.getCurrentModel().model.id;var c=this.controller.getCurrentModel().getGameIndex();
ludo.getLocalStorage().save(b,c);if(!this.loadedFromHistory&&this.random){this.addToHistory(d)}if(this.random&&this.historyIndex==0){ludo.$(this.previousButtonId).disable()}else{ludo.$(this.previousButtonId).enable()}}.bind(this)}});var a=ludo.getLocalStorage().get(b,0);if(isNaN(a)){a=0}a=Math.max(0,a);if(a!=undefined){this.controller.getCurrentModel().setGameIndex(a)}else{a=0}if(this.random){if(this.history.length>0){this.loadFromHistory()}else{this.controller.loadRandomGame()}}else{this.controller.loadGameFromFile(a)}},addToHistory:function(a){this.history.push(a);if(this.history.length>this.historySize){this.history.shift()}this.historyIndex=this.history.length-1;this.saveHistory()},saveHistory:function(){ludo.getLocalStorage().save(this.historyKey,this.history.join(","))},saveHistoryIndex:function(){ludo.getLocalStorage().save(this.historyIndexKey,this.historyIndex)}});window.chess.isWordPress=true;chess.WPTactics2=new Class({Extends:chess.WPTemplate,boardSize:undefined,random:false,gameFinished:false,startTime:undefined,lastGameId:undefined,gameIndex:0,storageKey:undefined,validateGameData:false,storage:undefined,initialize:function(b){this.parent(b);var c=jQuery(this.renderTo);var a=c.width();c.css("height",Math.round(a+164+this.wpm_h));this.boardSize=a;if(b.random!=undefined){this.random=b.random}this.board=b.board||{};this.arrow=b.arrow||{};this.arrowSolution=b.arrowSolution||{};this.hint=b.hint||{};this.module=String.uniqueID();if(this.renderTo.substr&&this.renderTo.substr(0,1)!="#"){this.renderTo="#"+this.renderTo}var d=String.uniqueID();this.avId="av"+d;this.eloId="elo"+d;this.nextBtnId="btn"+d;this.reloadBtnId="btn_r"+d;this.clockId="clk"+d;this.iconId="icon"+d;this.colorViewId="clr"+d;if(this.canRender()){this.render()}},nextGame:function(){this.loadedFromHistory=false;if(this.random){this.controller.loadRandomGame()}else{this.loadNextGame()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:[{layout:{type:"linear",orientation:"vertical"},children:[{layout:{height:34},id:this.colorViewId,type:"chess.ColorView"},Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{height:this.boardSize},plugins:[Object.merge({type:"chess.view.highlight.Arrow"},this.arrow),Object.merge({type:"chess.view.highlight.ArrowTactic"},this.arrowSolution),Object.merge({type:"chess.view.highlight.SquareTacticHint"},this.hint)]},this.board),{height:48,cls:"wpc-user-info-panel",layout:{type:"linear",orientation:"horizontal"},children:[{type:"chess.UserAvatarView",id:this.avId,auto:false,layout:{width:48,height:"matchParent"}},{module:this.module,type:"chess.UserElo",id:this.eloId,css:{"line-height":"40px"},layout:{weight:1,height:"matchParent"}},{id:this.clockId,type:"chess.Clock",layout:{weight:1,height:"matchParent"}}]},{layout:{height:48,type:"linear",orientation:"horizontal"},children:[{id:this.iconId,type:"chess.IconView",layout:{width:48,height:"matchParent"}},{weight:1},{id:this.reloadBtnId,type:"chess.ImageButton",img:this.dr+"images/reload.png",layout:{width:80,height:"matchParent"},btnVisible:false,listeners:{click:this.reloadGame.bind(this)}},{id:this.nextBtnId,type:"chess.ImageButton",img:this.dr+"images/btn-next.png",layout:{width:80,height:"matchParent"},btnVisible:false,listeners:{click:this.nextGame.bind(this)}}]}]}]});this.storageKey="wordpresschess_user_tactics";this.controller=new chess.controller.Controller({applyTo:[this.module],pgn:this.pgnId(),sound:this.sound,autoMoveDelay:400,noDialogs:true,eventHandler:this.eventHandler.bind(this)});this.loadUserInfo()},loadNextGame:function(){this.validateGameData=true;this.loadGame(this.getIndex()+1)},getIndex:function(){return this.storageVal("index",0)},loadGame:function(a){jQuery.ajax({url:this.url,method:"post",cache:false,dataType:"json",data:{action:"game_by_index_strict",pgn:this.pgnId(),index:a},complete:function(c,e){this.gameFinished=false;if(e){var d=c.responseJSON;if(d.success){this.onGameLoaded(d.response)}else{var b=this.nextPgnId();this.pgnId(b);this.saveStorageVal("index",0);this.loadGame(0)}}}.bind(this)})},onGameLoaded:function(c){var d=c.id;var a=c.pgn_id;var b=c.index;this.curModel().populate(c);ludo.$(this.eloId).clearIncs();this.saveStorageVal("id",d);this.pgnId(a);this.saveStorageVal("index",b);this.updateServerStore()},updateServerStore:function(){jQuery.ajax({url:this.url,method:"post",cache:false,dataType:"json",data:{action:"wpc_save_tactics_data",pgn:this.pgnId(),gameId:this.storageVal("id"),index:this.storageVal("index")}})},pgnId:function(a){if(arguments.length==1){this.saveStorageVal("pgn",a);return}return this.storageVal("pgn",this.pgn.id)},nextPgnId:function(){var b=this.pgnId();var a=0;jQuery.each(this.pgnAll,function(c,d){if(d.id==b){a=c}});if(a<this.pgnAll.length-1){a++}else{a=0}return this.pgnAll[a].id
},reloadGame:function(){this.curModel().toStart();ludo.$(this.iconId).animateOut();var a=ludo.$(this.clockId);a.reset();a.start()},myColor:undefined,eventHandler:function(g,f,e,d){var c=e.views.board;if(g=="boardMove"){e.currentModel.tryNextMove(d)}if(g=="newGame"){var a=f.getResult();if(a==-1){c.flipToBlack();this.myColor="black"}else{c.flipToWhite();this.myColor="white"}if(f.model.moves.length>0){var h=ludo.$(this.clockId);h.reset();h.start()}ludo.$(this.iconId).animateOut();ludo.$(this.nextBtnId).hideButton();ludo.$(this.reloadBtnId).hideButton();ludo.$(this.colorViewId).hideView()}if(g=="setPosition"||g=="nextmove"){colorToMove=f.getColorToMove();if(colorToMove==this.myColor){c.enableDragAndDrop(f)}else{f.nextMove.delay(200,f)}}if(g=="wrongGuess"){this.onGameEnd(true)}if(g==="endOfBranch"){this.onGameEnd()}},getStorage:function(){if(this.storage==undefined){var a=ludo.getLocalStorage().get(this.storageKey);this.storage=a?a:{}}return this.storage},saveStorageVal:function(a,c){var b=this.getStorage();b[a]=c;ludo.getLocalStorage().save(this.storageKey,b)},storageVal:function(a,c){var b=this.getStorage();return b[a]!=undefined?b[a]:c},onGameEnd:function(d){var g=d?"incorrect-icon.png":"solved-icon.png";ludo.$(this.iconId).setIcon(this.dr+"images/"+g);if(this.gameFinished){return}var f=ludo.$(this.clockId);f.stop();this.gameFinished=true;var b=this.controller.getCurrentModel().model.moves.length;var e=f.elapsed();var a=!d;var c=ludo.$(this.colorViewId);c.showView();if(a){c.colorCls("wpc-tactics-solved");c.icon(this.dr+"images/solved-icon-white.png")}else{c.colorCls("wpc-tactics-failed");c.icon(this.dr+"images/incorrect-icon-white.png")}jQuery.ajax({url:this.url,method:"post",cache:false,dataType:"json",data:{action:"wpc_puzzle_complete",moves:b,solved:a?1:0,ms:e,puzzleId:this.controller.currentModel.getId()},complete:function(h,k){this.gameFinished=false;if(k){var i=h.responseJSON;var j=i.response;ludo.$(this.eloId).val(j);ludo.$(this.nextBtnId).showButton();ludo.$(this.reloadBtnId).showButton()}}.bind(this)})},showStartButton:function(){var a=this.startButton=jQuery('<div class="dhtml_chess_overlay_parent"><div class="dhtml_chess_overlay"></div><div class="dhtml_chess_overlay_image wpc-start-button-large"></div></div>');ludo.$(this.boardId).boardEl().append(a);a.on("click",this.loadFirstGame.bind(this))},showLogOnWarning:function(){ludo.$(this.clockId).reset();var a=jQuery('<div class="dhtml_chess_overlay_parent"><div class="dhtml_chess_overlay"></div><div class="dhtml_chess_overlay_image wpc-login-image"></div></div>');ludo.$(this.boardId).boardEl().append(a);a.css("cursor","pointer");a.on("click",function(){location.href=ludo.config.wpRoot+"/wp-login.php"})},loadFirstGame:function(){this.startButton.remove();if(this.random){this.controller.loadRandomGame()}else{this.loadGame(this.getIndex())}},loadUserInfo:function(){jQuery.ajax({url:this.url,method:"post",cache:false,dataType:"json",data:{action:"wpc_userinfo",size:32},complete:function(a,d){if(d){var c=a.responseJSON.response;if(c.id==0){this.showLogOnWarning();return}if(c.tactics){var b=c.tactics;if(b.pgn&&this.isValidPgn(b.pgn)){this.pgnId(b.pgn);this.saveStorageVal("id",b.gameId);this.saveStorageVal("index",b.index)}}ludo.$(this.avId).setAvatar(c.avatar);ludo.$(this.eloId).val(c.puzzleelo);this.showStartButton()}else{}}.bind(this)})}});chess.WPTacticsGame1=new Class({Extends:chess.WPTemplate,nav:false,initialize:function(b){this.parent(b);var c=this.renderTo;var a=c.width();this.model=b.model||undefined;c.css("height",a+this.wpm_h);this.boardId="board"+String.uniqueID();if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:this.renderTo,layout:{type:"linear",orientation:"vertical"},children:[{module:this.module,id:this.boardId,type:"chess.view.board.Board",fen:this.fen,layout:{width:"matchParent",weight:1}},{type:"chess.WPComMessage"}]});this.controller=new chess.controller.TacticControllerGui({applyTo:[this.module],autoMoveDelay:400,sound:this.sound,noDialogs:true,gameEndHandler:this.onGameEnd.bind(this)});this.controller.currentModel.populate(this.model)},onGameEnd:function(){var a=jQuery('<div class="dhtml_chess_game_solved"><div class="dhtml_chess_overlay"></div><div class="dhtml_chess_overlay_image dhtml_chess_game_solved_image"></div></div>');ludo.$(this.boardId).boardEl().append(a)}});chess.WPFen=new Class({Extends:chess.WPTemplate,fen:undefined,nav:false,highlight:undefined,arrows:undefined,buttonHeight:35,initialize:function(b){this.parent(b);var a=this.renderTo.width();var c=this.comp?this.buttonHeight:0;this.renderTo.css("height",a+c+this.wpm_h);this.fen=b.fen;if(b.highlight!=undefined){this.highlight=b.highlight}if(b.arrows!=undefined){this.arrows=b.arrows}if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"linear",orientation:"vertical"},children:[{module:this.module,type:"chess.view.board.Board",id:this.boardId,fen:this.fen,layout:{width:"matchParent",weight:1}},{height:this.buttonHeight,hidden:!this.compToggle,module:this.module,type:"chess.view.buttonbar.Bar",buttons:["flip","comp"]},{type:"chess.WPComMessage",hidden:this._p}]});
if(this.highlight!=undefined){var f=new chess.view.highlight.SquarePool({board:ludo.$(this.boardId)});var d=this.highlight.split(/\,/g);var c=undefined;jQuery.each(d,function(g,h){var j=h.split(/;/g);if(j.length>0){c=j[1]}f.show(j[0],c)})}if(this.arrows!=undefined){var e=new chess.view.highlight.ArrowPool({board:ludo.$(this.boardId)});var b=this.arrows.split(/,/g);var a;jQuery.each(b,function(h,k){var l=k.split(/;/g);if(l.length>1){if(a==undefined){a={}}a.fill=a.stroke=l[1]}var j=l[0].substr(0,2);var g=l[0].substr(2,2);e.show(j,g,a)})}if(this.compToggle){this.createController()}},createController:function(){this.controller=new chess.controller[this.controllerType()]({applyTo:[this.module],stockfish:ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js",sound:this.sound});this.parent();this.controller.setPosition(this.fen)}});chess.WPPinned=new Class({Extends:chess.WPTemplate,renderTo:undefined,pgn:undefined,controller:undefined,module:undefined,random:false,color:undefined,parser:undefined,pinnedMsgId:undefined,arrowPool:undefined,solved:false,initialize:function(b){this.parent(b);this.renderTo=b.renderTo;var c=jQuery(this.renderTo);c.addClass("ludo-twilight");var a=c.width();c.css("height",Math.round(a+65+this.wpm_h));this.boardSize=a;if(b.random!=undefined){this.random=b.random}this.board=b.board||{};this.arrow=b.arrow||{};this.arrowSolution=b.arrowSolution||{};this.hint=b.hint||{};this.module=String.uniqueID();this.pinnedMsgId="dc-"+String.uniqueID();this.showLabels=!ludo.isMobile;if(this.renderTo.substr&&this.renderTo.substr(0,1)!="#"){this.renderTo="#"+this.renderTo}if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({cls:this.th,renderTo:jQuery(this.renderTo),layout:{type:"fill",height:"matchParent",width:"matchParent"},children:[{layout:{type:"linear",orientation:"vertical"},children:[{id:this.pinnedMsgId,module:this.module,css:{"text-align":"center","line-height":"30px"},layout:{height:30}},Object.merge({boardLayout:undefined,id:this.boardId,type:"chess.view.board.Board",module:this.module,overflow:"hidden",pieceLayout:"svg3",boardCss:{border:0},labelPos:this.lp,layout:{height:this.boardSize}},this.board),{css:{"padding-top":5},layout:{height:35,type:"linear",orientation:"horizontal"},children:[{weight:1},{type:"form.Button",value:"Solve",listeners:{click:this.sendSolution.bind(this)}},{type:"form.Button",value:chess.__("Hint"),listeners:{click:this.showHint.bind(this)}},{type:"form.Button",value:chess.__("Next"),listeners:{click:function(){this.controller.loadNextGameFromFile()}.bind(this)}},{weight:1}]},{type:"chess.WPComMessage",hidden:this._p}]}]});var c="wp_"+this.pgn.id+"_pinned";new chess.view.message.TacticsMessage({renderTo:document.body,module:this.module,showIntro:false,hidden:true,autoHideWelcomeAfterMs:20,css:{"background-color":"#eee","border-radius":5},layout:{width:200,height:50,centerIn:ludo.$("chess-board-pinned-pieces")}});this.controller=new chess.controller.Controller({applyTo:[this.module],pgn:this.pgn.id,gameEndHandler:function(d){if(this.random){d.loadRandomGame()}else{d.loadNextGameFromFile()}}.bind(this),listeners:{loadGame:this.findPinned.bind(this),startOfGame:function(){ludo.getLocalStorage().save(c,this.controller.getCurrentModel().getGameIndex())}.bind(this)}});var b=this.controller;var a=ludo.getLocalStorage().get(c,0);if(isNaN(a)){a=0}a=Math.max(0,a);if(a!=undefined){b.getCurrentModel().setGameIndex(a)}else{a=0}if(this.random){this.controller.loadRandomGame()}else{this.controller.loadGameFromFile(a)}this.hPool=new chess.view.highlight.SquarePool({board:ludo.$(this.boardId)});this.interaction=new chess.view.board.BoardInteraction({board:ludo.$(this.boardId)});this.interaction.on("click",function(d){this.hPool.toggle(d,undefined)}.bind(this));this.arrowPool=new chess.view.highlight.ArrowPool({board:ludo.$(this.boardId)})},findPinned:function(){if(this.parser==undefined){this.parser=new chess.parser.FenParser0x88()}this.parser.setFen(this.controller.currentModel.fen());var b=this.parser.getColor();this.color=b=="white"?"black":"white";this.hPool.hideAll();var a=this.parser.getPinnedSquares(this.color);if(a.length==0){controller.loadGameFromFile()}else{ludo.$(this.boardId).flipTo(b);this.showIntroDialog()}},sendSolution:function(){var a=this.parser.getPinnedSquares(this.color)||[];var b=this.hPool.getSquares()||[];var c=true;if(a.length!=b.length){c=false}if(b.length==0){this.showToast()}if(!c){var e=function(g,f){return g<f?-1:1};a.sort(e);b.sort(e);for(var d=0;d<a.length;d++){if(c&&a[d]!=b[d]){c=false}}}if(!c){this.controller.fireEvent("wrongGuess")}else{this.showSolvedDialog()}},toast:undefined,getToast:function(){if(this.toast==undefined){this.toast=new ludo.Notification({autoRemove:false,duration:2,layout:{centerIn:this.boardId,height:30},css:{"text-align":"center"},html:chess.__("Click squares to solve the puzzles")})}return this.toast},showToast:function(){this.getToast().show(chess.__("Click squares to solve the puzzles"))},showIntroDialog:function(){this.solved=false;
this.arrowPool.hideAll();var a=chess.__("Click on all "+this.color+"'s pinned pieces");this.getToast().show(a);ludo.$(this.pinnedMsgId).html(a)},showHint:function(){if(this.solved){return}var a=this.parser.getPinnedSquares(this.color);this.getToast().show(chess.__("There are {0} pinned pieces".replace("{0}",a.length)))},overlay:undefined,showSolvedDialog:function(){this.solved=true;if(this.overlay==undefined){this.overlay=jQuery('<div class="dhtml_chess_game_solved"><div class="dhtml_chess_game_solved_overlay"></div><div class="dhtml_chess_game_solved_image"></div></div>');ludo.$(this.boardId).boardEl().append(this.overlay)}this.overlay.css("opacity",1);this.overlay.show();this.hideOverlay.delay(2000,this);var a=this.parser.getPinnedReadable(this.color);jQuery.each(a,function(c,b){this.arrowPool.show(b.by,b.king)}.bind(this))},hideOverlay:function(){this.overlay.animate({opacity:0},{duration:700,complete:function(){this.overlay.hide()}.bind(this)})}});chess.WPStandings1=new Class({Extends:chess.WPTemplate,initialize:function(a){this.parent(a);jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:{action:"get_standings",pgn:this.pgn.id},complete:function(d,c){if(c=="success"){var b=d.responseJSON.response;new chess.wordpress.PgnStandings({renderTo:this.renderTo,layout:{height:"auto"},dataSource:{data:b}})}}.bind(this),fail:function(c,b){this.fireEvent(b)}.bind(this)})}});chess.computer.Elo=new Class({K:30,PROVISIONAL:8,db:undefined,MIN_ELO:800,clearAll:function(){this.db.empty()},initialize:function(){this.db=ludo.getLocalStorage()},hasPlayedBefore:function(){return this.db.get("played","0")=="1"},getGameType:function(a,c){var b=a+(c*30);if(b<60*3){return"bullet"}if(b<=60*8){return"blitz"}return"classical"},getEloByTime:function(b,a){return this.getElo(this.getGameType(b,a))},getElo:function(a){return Math.max(this.MIN_ELO,this.db.getNumeric("elo"+a,1200))},saveResult:function(m,a,l,b){this.db.save("played","1");var i=this.incrementGames(l);var d;if(i<=this.PROVISIONAL){var j=this.db.get("provisional"+l,[]);var h=m==-1?a-400:m==0?a:a+400;h=Math.max(this.MIN_ELO,h);j.push(h);this.db.save("provisional"+l,j);var g=0;jQuery.each(j,function(c,e){g+=e});d=Math.max(this.MIN_ELO,g/j.length)}else{var f=this.getElo(l);if(b=="black"){a*=1.05}else{a-=(a*0.05)}var k=this.getRatingAdjustment(f,a,m);d=f+k}return this.db.save("elo"+l,d)},getRatingAdjustment:function(c,b,a){a+=1;a/=2;var d=this.getExpectedScore(c,b);return this.K*(a-d)},getExpectedScore:function(a,d){var c=Math.pow(10,a/400);var b=Math.pow(10,d/400);return c/(c+b)},incrementGames:function(a){var b=this.countGames(a)+1;this.db.save("games"+a,b);return b},countGames:function(a){return this.db.getNumeric("games"+a,0)}});chess.computer.Clock=new Class({Extends:Events,time:undefined,increment:undefined,turn:"white",savedTime:undefined,started:false,initialize:function(){this.tick()},tick:function(){if(this.started){this.validateTime();this.onChange()}this.tick.delay(100,this)},stop:function(){this.time[this.turn]=this.getTime(this.turn);this.started=false;this.savedTime=new Date().getTime();this.onChange()},validateTime:function(){var a=this.getTime(this.turn);if(a==0){this.time[this.turn]=this.getTime(this.turn);this.onChange();this.fireEvent("end",this.turn);this.started=false}},wTime:function(){return this.getTime("white")},bTime:function(){return this.getTime("black")},inc:function(){return this.increment},setTime:function(b,a){a=a||0;this.time={};this.time.white=b*1000;this.time.black=b*1000;this.increment=a*1000;this.onChange()},start:function(b,a){if(arguments.length==2){this.setTime(b,a)}this.turn="white";this.savedTime=new Date().getTime();this.started=true;this.onChange()},tap:function(){this.time[this.turn]=this.getTime(this.turn)+this.increment;this.turn=this.turn=="white"?"black":"white";this.savedTime=new Date().getTime();this.onChange()},getTime:function(a){var b=this.time[a];if(this.turn==a&&this.started){b-=new Date().getTime()-this.savedTime}return Math.max(0,b)},onChange:function(){this.fireEvent("change",[this.turn,this.timeAsObject("white"),this.timeAsObject("black")])},timeAsObject:function(c){var f=this.getTime(c);var b=f<10000?parseInt((f/100)%10):undefined,g=parseInt((f/1000)%60),e=parseInt((f/(1000*60))%60),a=parseInt((f/(1000*60*60))%24);var d={h:a,m:this.pad(e,2),s:this.pad(g,2),d:b,totalSeconds:f/1000};d.string=(d.h>0?d.h+":":"")+d.m+":"+d.s+(d.totalSeconds<10?":"+d.d:"");return d},pad:function(a,b){var c=a+"";while(c.length<b){c="0"+c}return c}});chess.computer.ClockView=new Class({Extends:ludo.View,color:undefined,module:"chess",submodule:"computer.clockview",elo:undefined,pos:undefined,lastColor:undefined,__construct:function(a){this.parent(a);this.color=a.color;this.pos=a.pos},setColor:function(a){this.color=a;this.$b().removeClass("clock-turn");this.lastColor=undefined},__rendered:function(){this.parent();this.$e.addClass("dhtml-chess-clock");this.showTime()},setController:function(a){this.parent(a);
if(a.clock){a.clock.on("change",this.update.bind(this))}this.elo=a.elo},update:function(b,a,c){var d=this.color=="white"?a:c;if(b!=this.lastColor){this.$b().removeClass("clock-turn");if(b==this.color){this.$b().addClass("clock-turn")}}this.$b().html(d.string);this.lastColor=b},resize:function(a){this.parent(a);this.getBody().css({"line-height":a.height+"px","font-size":(a.height*0.6)+"px"})},showTime:function(a){if(a==undefined){this.getBody().html("00:00")}else{}}});chess.computer.GameDialog=new Class({Extends:ludo.dialog.Dialog,module:"chess",submodule:"chess.computer.gamedialog",autoRemove:false,layout:{width:300,height:300,type:"table",simple:true,columns:[{weight:1},{width:50},{weight:1},{width:50}]},css:{padding:10},buttonConfig:"Ok",elo:undefined,color:undefined,modal:false,__construct:function(a){a=a||{};a.title=chess.__("New Game");this.parent(a);this.elo=new chess.computer.Elo()},__rendered:function(){this.parent();this.$b().addClass("dhtml-chess-comp-dialog");this.on("ok",this.onNewGame.bind(this));this.selectColor("white");this.child["color-white"].$b().on("click",function(){this.selectColor("white")}.bind(this));this.child["color-black"].$b().on("click",function(){this.selectColor("black")}.bind(this))},selectColor:function(b){this.color=b;var a="dhtml-chess-comp-dialog-selected-color";this.child["color-black"].$b().removeClass(a);this.child["color-white"].$b().removeClass(a);this.child["color-"+b].$b().addClass(a)},__children:function(){return[{type:"form.Label",label:chess.__("Your color:"),layout:{colspan:4}},{name:"color-white",layout:{colspan:2,height:50},elCss:{margin:2},css:{"border-radius":"5px","background-color":"#CCC",color:"#444",cursor:"pointer","line-height":"45px",border:"2px solid transparent","text-align":"center"},html:chess.__("White")},{name:"color-black",layout:{colspan:2,height:50},elCss:{margin:"2px"},css:{"border-radius":"5px",cursor:"pointer","background-color":"#777",color:"#fff","line-height":"45px",border:"3px solid transparent","text-align":"center"},html:chess.__("Black")},{type:"form.Label",label:chess.__("Opponent rating:"),labelFor:"name",layout:{colspan:2}},{type:"form.Number",name:"stockfishElo",placeholder:chess.__("ex: 1400")},{layout:{colspan:1}},{layout:{colspan:4,height:20}},{type:"form.Label",label:chess.__("Time"),css:{"font-size":"1.3em"},layout:{colspan:2}},{type:"form.Label",label:chess.__("Increment"),layout:{colspan:2}},{type:"form.Select",name:"game-time",value:5,dataSource:{data:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,20,30,45,60,90,120]},listeners:{change:this.onTimeChange.bind(this)}},{html:chess.__("min"),css:{padding:5}},{type:"form.Select",name:"game-inc",value:3,dataSource:{data:[0,1,2,3,5,10,12,15,30]},listeners:{change:this.onTimeChange.bind(this)}},{html:chess.__("sec"),css:{padding:5}},{elCss:{"margin-top":10},css:{"text-align":"center"},name:"your-elo",layout:{colspan:4},html:chess.__("Your rating")}]},onTimeChange:function(){var b=this.child["game-time"].val()/1;var d=this.child["game-inc"].val()/1;var a=this.elo.getGameType(b*60,d);var c=Math.round(this.elo.getElo(a));this.child["your-elo"].html(chess.__("Your rating")+": "+c+" ("+a+")");this.child.stockfishElo.val(c)},setController:function(a){this.parent(a);this.controller.on("newgamedialog",this.show.bind(this))},show:function(){this.parent();this.onTimeChange()},onNewGame:function(){this.fireEvent("newGame",{time:this.child["game-time"].val()/1,inc:this.child["game-inc"].val()/1,elo:this.child.stockfishElo.val()/1,color:this.color})}});chess.computer.DialogTimeButton=new Class({Extends:ludo.View,__construct:function(a){this.parent(a);this.time=a.time}});chess.computer.ComputerStatusDialog=new Class({Extends:ludo.dialog.Dialog,module:"chess",modal:true,submodule:"chess.computer.computerstatusdialog",updateFn:undefined,layout:{type:"relative",width:300,height:100},css:{"text-align":"center"},__construct:function(a){a.title=a.html=chess.__("Loading Stockfish JS");this.parent(a)},__children:function(){return[{name:"status",layout:{width:"matchParent",centerVertical:true},css:{"text-align":"center"}}]},setController:function(a){this.parent(a);this.updateFn=function(c,b){this.child.status.html(c);if(b){this.hide.delay(100,this)}}.bind(this);a.on("enginestatus",this.updateFn)},remove:function(){if(this.updateFn){this.controller.off("enginestatus",this.updateFn);this.updateFn=undefined}this.parent()}});chess.computer.GameOverDialog=new Class({Extends:ludo.dialog.Dialog,module:"chess",submodule:"chess.computer.gameoverdialog",autoRemove:false,hidden:true,layout:{width:300,height:200,type:"linear",orientation:"vertical"},buttonBar:{children:[{name:"rematch",value:chess.__("Rematch")},{value:chess.__("Exit")}]},__children:function(){return[{name:"title",css:{"margin-top":15,"text-align":"center","font-weight":"bold","font-size":"1.5em","line-height":"25px"},layout:{height:50}},{css:{"text-align":"center"},name:"rating"}]},__rendered:function(){this.parent();this.getButton("rematch").on("click",this.onNewGameClick.bind(this))
},onNewGameClick:function(){this.fireEvent("newgame")},setController:function(a){this.parent(a);a.on("gameover",this.onGameOver.bind(this))},onGameOver:function(e,c,d){this.show();var g=e==1?chess.__("You Won"):e==0?chess.__("Game Drawn"):chess.__("You lost");this.setTitle(g);var a=this.child.title.$b();a.removeClass("title-win");a.removeClass("title-draw");a.removeClass("title-loss");this.child.title.html(g);var f=d-c;if(e==0){a.addClass("title-draw")}else{if(e==1){a.addClass("title-win")}else{a.addClass("title-loss")}}if(f>1){f='<span class="rating-change-win">+'+f+"</span>"}else{if(f==0){f='<span class="rating-change-draw">'+f+"</span>"}else{f='<span class="rating-change-loss">'+f+"</span>"}}this.child.rating.html(chess.__("New rating")+': <span class="new-rating">'+d+"</span> ("+f+")")}});chess.controller.PlayStockFishController=new Class({Extends:chess.controller.Controller,stockfish:undefined,history:undefined,engineStatus:{},whiteTime:1000*60,blackTime:1000*60,whiteIncrement:1,blackIncrement:1,playerColor:"white",elo:undefined,clock:undefined,playingStrength:undefined,stockfishElo:undefined,gameType:undefined,turn:undefined,isPlaying:false,clockAndElo:true,startFen:undefined,autoFlip:true,__construct:function(a){if(a.playerColor!=undefined){this.playerColor=a.playerColor}if(a.stockfish!=undefined){this.stockfish=a.stockfish}if(a.thinkingTime!=undefined){this.thinkingTime=a.thinkingTime}if(this.clockAndElo){this.elo=new chess.computer.Elo();this.clock=new chess.computer.Clock();this.clock.on("end",this.onTimesUp.bind(this))}this.parent(a);this.history=[]},addView:function(a){this.parent(a);switch(a.submodule){case"chess.computer.gamedialog":a.on("newGame",this.prepareNewGame.bind(this));break;case"computer.clockview":if(!a.isHidden()){if(a.pos=="top"){this.views.clockTop=a}else{this.views.clockBottom=a}}break;case"chess.computer.gameoverdialog":a.on("newgame",function(){this.fireEvent("newgamedialog")}.bind(this));break}},getSkillLevel:function(){if(this.stockfishElo<1400){return 0}var a=this.stockfishElo;if(a>2800){return 20}if(a>2700){return 19}if(a>2600){return 17}if(a>2500){return 15}if(a>2400){return 13}if(a>2300){return 11}if(a>2200){return 10}if(a>2100){return 9}if(a>2000){return 8}if(a>1900){return 6}if(a>1800){return 5}if(a>1700){return 4}if(a>1600){return 3}if(a>1500){return 2}return 1},prepareNewGame:function(a){this.turn="white";this.playerColor=a.color;this.stockfishElo=a.elo;this.history=[];this.clock.setTime(a.time*60,a.inc);this.clock.start();this.currentModel.newGame();this.gameType=this.elo.getGameType(a.time*60,a.inc);this.playingStrength=this.elo.getEloByTime(a.time*60,a.inc);this.isPlaying=true;this.runGameStartCommands();this.prepareBoard(a);this.prepareMove()},runGameStartCommands:function(){this.uciCmd("setoption name Mobility (Middle Game) value 150");this.uciCmd("setoption name Mobility (Endgame) value 150");this.uciCmd("setoption name Contempt Factor value 0");this.uciCmd("setoption name UCI_LimitStrength value 1200");this.uciCmd("setoption name Skill Level value "+this.getSkillLevel());this.uciCmd("ucinewgame")},prepareBoard:function(a){if(a.color=="white"){this.views.board.flipToWhite();this.views.clockTop.setColor("black");this.views.clockBottom.setColor("white")}else{this.views.board.flipToBlack();this.views.clockTop.setColor("white");this.views.clockBottom.setColor("black")}},promotion:function(a){},engineLoaded:function(){return this.engineStatus.engineLoaded},createEngine:function(){try{var b=this;this.fireEvent("createngine");this.engine=new Worker(this.stockfish);this.fireEvent("enginestatus",chess.__("loading StockfishJS"));this.uciCmd("uci");this.uciCmd("ucinewgame");this.engine.onmessage=function(g){var c=g.data;if(c=="uciok"){b.fireEvent("enginestatus",chess.__("StockfishJS loaded. Loading Opening Book"));if(!b.engineStatus.engineLoaded){b.engineStatus.engineLoaded=true;jQuery.ajax({url:ludo.config.getUrl()+"/stockfish-js/book.bin",complete:function(k){this.engine.postMessage({book:k.responseText});this.fireEvent("enginestatus",[chess.__("Stockfish Ready"),true]);this.fireEvent("newgamedialog")}.bind(b)})}}else{if(c=="readyok"){b.engineStatus.engineReady=true}else{var f=c.match(/^bestmove ([a-h][1-8])([a-h][1-8])([qrbk])?/);if(f){if(b.turn!=b.playerColor){b.currentModel.move({from:f[1],to:f[2],promoteTo:f[3]})}}if(f=c.match(/^info .*\bscore (\w+) (-?\d+)/)){var e=c.replace(/.*pv(.+?)$/g,"$1").trim();var j=c.replace(/.*nps.*?([0-9]+?)[^0-9].+/g,"$1");var i=c.replace(/.*?depth ([0-9]+?)[^0-9].*/g,"$1").trim();var d={depth:i,bestMoves:e,nps:j,mate:false,currentPly:b.currentPly};if(f[1]=="cp"){var h=parseInt(f[2])*(b.colorToMove=="white"?1:-1);h=(h/100).toFixed(2)}else{if(f[1]=="mate"){d.mate=f[2]*(b.colorToMove=="white"?1:-1);h="#"+Math.abs(parseInt(d.mate))}}d.score=h;d.scoreLiteral=!isNaN(h)&&h>0?"+"+h:h;b.fireEvent("engineupdate",d)}}}};this.engine.error=function(c){this.fireEvent("message","Error from background worker:"+c.message)}.bind(this)}catch(a){this.backgroundEngineValid=false
}},newGame:function(){this.history=[];this.currentModel.newGame();this.start();this.prepareMove()},start:function(){this.uciCmd("ucinewgame");this.uciCmd("isready");this.engineStatus.engineReady=false;this.engineStatus.search=null;this.prepareMove()},prepareMove:function(){var b=this.currentModel.turn();if(b!=this.playerColor){if(this.history==undefined){this.history=[]}var a=this.startFen?"position fen "+this.startFen:"position startpos";this.uciCmd(a+" moves "+this.history.join(" "));if(this.playingStrength<=1200){this.uciCmd("go depth "+this.strengthToDepth())}else{this.uciCmd("go wtime "+this.getWTime()+" winc "+this.getInc("white")+" btime "+this.getBTime()+" binc "+this.getInc("black"))}}},getWTime:function(){if(this.playerColor=="white"){return this.clock.wTime()}return this.strengthToTime()},getBTime:function(){if(this.playerColor=="black"){return this.clock.bTime()}return this.strengthToTime()},strengthToTime:function(){var a=this.stockfishElo;if(a<=800){return 500}if(a<=1000){return 1000}if(a<=1200){return 2000}if(a<=1400){return 3000}if(a<=1500){return 4000}if(a<=1600){return 5000}if(a<=1700){return 7000}if(a<=1800){return 9000}if(a<=1900){return 12000}return 20000},getInc:function(a){if(this.clock&&this.playerColor==a){return this.clock.inc()}return 0},strengthToDepth:function(){var b=this.stockfishElo;var c;for(var a in this._strengthToDepths){if(b<=a){c=this._strengthToDepths[a];break}}if(c==undefined){c=20}return c},_strengthToDepths:{800:1,900:2,1000:3,1200:4,1300:5,1400:6,1600:8,1700:10,1800:12,1900:13,2000:14,2100:16,2200:18,2250:20,2300:21,2400:22,2500:23,2600:23},uciCmd:function(a){this.engine.postMessage(a)},modelEventFired:function(d,c,b){if(d==="newMove"||d=="newGame"){if(d=="newGame"){if(this.autoFlip){if(this.playerColor=="white"){this.views.board.flipToWhite()}else{this.views.board.flipToBlack()}}if(this.engine==undefined){this.createEngine()}}var e=this.colorToMove=c.turn();if(d=="newMove"){if(this.clock){this.clock.tap()}this.turn=this.turn=="white"?"black":"white";if(this.history==undefined){this.history=[]}this.history.push(b.from+b.to+(b.promoteTo?b.promoteTo:""));this.start();if(e!=this.playerColor){this.prepareMove()}}if(c.getResult()!=0){var a=c.getResult();this.onGameOver(a);return}if(e===this.playerColor){this.views.board.enableDragAndDrop(c)}else{this.views.board.disableDragAndDrop();if(d=="newGame"){this.prepareMove()}}}},onGameOver:function(a){if(!this.isPlaying){return}this.views.board.disableDragAndDrop();this.elo.saveResult(a,this.stockfishElo,this.gameType,this.playerColor);var c=Math.round(this.elo.getElo(this.gameType));var b=this.playerColor=="black"?a*-1:a;this.fireGameOverEvent.delay(300,this,[b,Math.round(this.playingStrength),c]);this.clock.stop();this.isPlaying=false},fireGameOverEvent:function(b,c,a){this.fireEvent("gameover",[b,c,a])},onTimesUp:function(a){this.onGameOver(a=="white"?-1:1)},claimDraw:function(){if(this.currentModel.canClaimDraw()){this.onGameOver(0)}},resign:function(){this.onGameOver(this.playerColor=="white"?-1:1)}});window.chess.isWordPress=true;chess.WPComp1=new Class({Extends:chess.WPTemplate,boardId:undefined,boardSize:undefined,isPreview:false,nav:false,initialize:function(b){this.parent(b);var e=this.renderTo;var a=e.width();var d=(a+50)/(a+200+this.wpm_h);var c=ludo.isMobile?a+150+this.wpm_h:a*d;e.css("height",Math.round(c));if(b.isPreview){this.isPreview=b.isPreview}this.boardSize=ludo.isMobile?a:a-200;this.boardId="dhtml-chess-"+String.uniqueID();if(this.canRender()){this.render()}},render:function(){new chess.view.Chess({renderTo:jQuery(this.renderTo),layout:{width:"matchParent",height:"matchParent",type:"linear",orientation:"vertical"},children:[{hidden:!ludo.isMobile,type:"chess.computer.ClockView",module:this.module,color:"white",pos:"top",css:{"text-align":"center"},layout:{height:50,width:150,anchor:0.5,alignTop:"board",rightOf:"board"}},{layout:{weight:1,type:"linear",orientation:"horizontal"},children:[{id:this.boardId,type:"chess.view.board.Board",pieceLayout:"svg_egg",boardLayout:"wood",module:this.module,padding:ludo.isMobile?"1%":"2.5%",labels:!ludo.isMobile,background:{borderRadius:"1%",paint:{fill:"#444"}},layout:{height:"matchParent",weight:1},plugins:[{type:"chess.view.highlight.Arrow"}]},{width:205,hidden:ludo.isMobile,css:{"margin-left":5},layout:{type:"linear",orientation:"vertical"},children:[{id:"clockTop",module:this.module,type:"chess.computer.ClockView",color:"white",pos:"top",layout:{height:50,alignTop:"board",rightOf:"board"}},{weight:1},{id:"clockBottom",module:this.module,type:"chess.computer.ClockView",color:"black",pos:"bottom",layout:{height:50,alignBottom:"board",rightOf:"board"}}]}]},{hidden:!ludo.isMobile,type:"chess.computer.ClockView",module:this.module,color:"white",pos:"bottom",css:{"text-align":"center"},layout:{anchor:0.5,height:50,width:150,alignTop:"board",rightOf:"board"}},{css:{"margin-top":5},layout:{height:35,width:this.boardSize,type:"linear",orientation:"horizontal"},children:[{weight:1},{type:"form.Button",module:this.module,value:"Draw",listeners:{click:function(){this.controller.claimDraw()
}.bind(this)}},{type:"chess.view.notation.LastMove",module:this.module,css:{"border-radius":"999px","background-color":"#ddd",color:"#444","border-color":"1px solid "+ludo.$C("border")},layout:{width:100,height:40}},{type:"form.Button",value:"Resign",module:this.module,listeners:{click:function(){this.controller.resign()}.bind(this)}},{weight:1}]},{module:this.module,submodule:"message",layout:{height:30}},{type:"chess.WPComMessage",hidden:this._p}]});this.controller=new chess.controller.PlayStockFishController({applyTo:[this.module],sound:this.sound,stockfish:ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js",playerColor:"white",listeners:{start:this.onNewGame.bind(this),engineupdate:this.updateMove.bind(this)},thinkingTime:3000});if(!this.isPreview){new chess.computer.GameOverDialog({module:this.module,layout:{centerIn:ludo.$(this.boardId)},movable:false,resizable:false});new chess.computer.GameDialog({module:this.module,hidden:true,layout:{centerIn:ludo.$(this.boardId)},movable:false,resizable:false});var a=new chess.computer.ComputerStatusDialog({module:this.module,layout:{centerIn:ludo.$(this.boardId)},movable:false,resizable:false});a.show()}},setThinkingTime:function(a){this.controller.setThinkingTime(a)},updateMove:function(a){},onNewGame:function(c){var a=ludo.get(this.boardId);if(c=="black"){a.flipToBlack()}else{a.flipToWhite()}}});chess.Clock=new Class({Extends:ludo.View,startTime:0,endTime:0,cv:undefined,stopped:true,interval:undefined,__rendered:function(){this.parent();this.$b().addClass("wpc-clock");this.cv=jQuery('<div class="wpc-clock-digits"></div>').appendTo(this.$b());this.reset();this.showTime()},createInterval:function(){if(this.interval){clearInterval(this.interval)}this.interval=setInterval(this.showTime.bind(this),1000)},reset:function(){this.stopped=true;this.startTime=this.endTime=new Date().getTime()},start:function(){this.stopped=false;this.createInterval();this.showTime()},stop:function(){this.stopped=true;this.endTime=new Date().getTime()},elapsed:function(){if(this.stopped){return this.endTime-this.startTime}return new Date().getTime()-this.startTime},timeAsString:function(){var a=this.elapsed();var c=Math.floor(a/1000);var b=Math.floor(c/60);c=c%60;var d=c<10?"0":"";return b+":"+d+c},showTime:function(){this.cv.html(this.timeAsString())},resize:function(a){this.parent(a);var b=this.$b().height();this.cv.css({"margin-top":Math.floor(b*0.05)+"px","font-size":b});if(!ludo.isMobile){this.cv.css("line-height",b+"px")}}});chess.ColorView=new Class({Extends:ludo.View,colorView:undefined,ccls:undefined,__rendered:function(){this.parent();this.colorView=jQuery('<div class="wpc-color-view"></div>').appendTo(this.$b());this.$b().addClass("wpc-color-view-parent")},colorCls:function(a){if(this.ccls){this.colorView.removeClass(this.ccls)}this.colorView.addClass(a);this.ccls=a},color:function(a){this.colorView.css("background-color",a)},icon:function(a){this.colorView.css("background-image","url("+a+")")},hideView:function(){this.animateOut()},showView:function(){this.animateIn()},animateIn:function(){this.colorView.css("top",this.$e.height());this.colorView.animate({top:0})},animateOut:function(){this.colorView.animate({top:this.$e.height()})}});chess.IconView=new Class({Extends:ludo.View,iconView:undefined,__rendered:function(){this.parent();this.iconView=jQuery('<div class="wpc-icon-view"></div>');this.$b().append(this.iconView)},setIcon:function(a){this.iconView.css("background-image","url("+a+")");this.animateIn()},animateIn:function(){this.iconView.css("top",this.$e.height());this.iconView.animate({top:0})},animateOut:function(){this.iconView.animate({top:this.$e.height()})}});chess.ImageButton=new Class({Extends:ludo.View,img:undefined,btnVisible:true,elCss:{padding:2},__construct:function(a){this.parent(a);this.__params(a,["img","btnVisible"])},__rendered:function(){this.parent();var a=this.$b();a.addClass("wpc-image-button");this.bg(this.img);a.mouseenter(this.onEnter.bind(this));a.mouseleave(this.onLeave.bind(this));if(!this.btnVisible){this.hideButton()}var c=function(){this.fireEvent("click")}.bind(this);this.$b().on("click",c)},onEnter:function(){this.$b().addClass("wpc-image-button-over")},onLeave:function(){this.$b().removeClass("wpc-image-button-over")},bg:function(a){this.$b().css("background-image","url("+a+")")},hideButton:function(){this.$b().css("visibility","hidden")},showButton:function(){if(this.hidden){this.show()}this.$b().css("visibility","visible")}});chess.UserAvatarView=new Class({Extends:ludo.View,avatarSize:32,auto:true,__construct:function(a){this.parent(a);if(a.avatarSize!=undefined){this.avatarSize=a.avatarSize}if(a.auto!=undefined){this.auto=a.auto}},setAvatar:function(a){var b=a.replace(/.*?src=["']([^"']+?)["'].*/gi,"$1");this.$b().css("background-image","url("+b+")")},__rendered:function(){this.parent();this.$b().addClass("wpc-avatar");if(this.auto){this.loadAvatar()}},loadAvatar:function(){jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:{action:"wpc_userinfo",size:this.avatarSize},complete:function(a,c){if(c){var b=a.responseJSON;
this.setAvatar(b.response.avatar)}else{}}.bind(this)})}});chess.UserElo=new Class({Extends:ludo.View,elo:undefined,cls:"wpc-user-info-elo",suffix:undefined,val:function(d){d=Math.floor(d);if(!this.elo){this.elo=d}var b="";if(this.elo&&d!=this.elo){var c=d-this.elo;b=c>0?"+"+c:c;var a=c>0?"wpc-positve-elo":"wpc-negative-elo";b=' (<span class="'+a+'">'+b+"</span>)"}this.html(this.elo+b);if(d!=this.elo){this.animateElo(this.elo,d)}this.elo=d;this.suffix=b},animateElo:function(b,a){this.html(Math.round(b)+this.suffix);if(b!=a){b+=a>b?1:-1;this.animateElo.delay(17,this,[b,a])}},clearIncs:function(){if(this.elo){this.val(this.elo)}}});