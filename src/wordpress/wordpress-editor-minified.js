// (C) dhtmlchess.com, Alf Kalleland 2018-03-04 01:14:07
/*
 * Copyright Â©2018. dhtmlchess.com. All Rights Reserved.
 * This is a commercial software. See dhtmlchess.com for licensing options.
 *
 * You are free to use/try this software for 30 days without paying any fees.
 *
 * IN NO EVENT SHALL DHTML CHESS BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL,
 * OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS, ARISING OUT OF THE USE OF THIS SOFTWARE AND
 * ITS DOCUMENTATION, EVEN IF DHTML CHESS HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * DHTML CHESS SPECIFICALLY DISCLAIMS ANY WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 * THE SOFTWARE AND ACCOMPANYING DOCUMENTATION, IF ANY, PROVIDED HEREUNDER IS PROVIDED "AS IS".
 * DHTML CHESS HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.
 *
 */
 chess.wordpress.PgnList=new Class({Extends:ludo.dataSource.JSONArray,type:"chess.dataSource.PgnList",autoload:true,postData:{action:"list_pgns"}});chess.wordpress.RenameDatabaseDialog=new Class({Extends:ludo.dialog.Dialog,submodule:"wordpress.publishdialog",modal:true,autoRemove:false,title:chess.__("Rename Database"),buttonConfig:"RenameCancel",layout:{width:300,height:150,type:"linear",orientation:"vertical"},css:{padding:5},pgn:undefined,__rendered:function(){this.parent();this.on("rename",this.sendRenameEvent.bind(this))},__children:function(){return[{type:"form.Label",label:chess.__("New name"),labelFor:"pgn_name"},{name:"pgn_name",type:"form.Text",required:true,placeholder:chess.__("New name")}]},show:function(a){this.pgn=a;this.parent();this.child.pgn_name.val(a.pgn_name);this.child.pgn_name.select()},sendRenameEvent:function(){this.fireEvent("renameDatabase",[this.pgn,this.child.pgn_name.val()])}});chess.wordpress.PublishDialog=new Class({Extends:ludo.dialog.Dialog,submodule:"wordpress.publishdialog",modal:true,buttonConfig:"OkCancel",title:chess.__("Publish Game"),layout:{width:300,height:400,type:"linear",orientation:"vertical"},pgn:undefined,__rendered:function(){this.parent();this.child.searchField.on("key",function(a){this.child.list.getDataSource().search(a)}.bind(this));this.on("ok",this.onSelected.bind(this));this.getButton("ok").setEnabled(false)},onSelected:function(){this.fireEvent("selectpgn",this.pgn)},selectPgn:function(a){this.pgn=a;this.child.selected.html(chess.__("Selected")+": "+a.pgn_name);this.getButton("ok").setEnabled(true)},__children:function(){return[{name:"heading",html:chess.__("Select PGN"),layout:{height:25},css:{"line-height":"25px","padding-left":"2px"}},{name:"searchField",type:"form.Text",placeholder:"Search",layout:{height:30},elCss:{"border-top":"1px solid "+ludo.$C("border"),"border-bottom":"1px solid "+ludo.$C("border")}},{name:"list",type:"grid.Grid",columns:{pgn_name:{heading:"PGN"}},headerMenu:false,dataSource:{type:"chess.wordpress.PgnList",autoload:true,listeners:{select:this.selectPgn.bind(this)}},layout:{weight:1},elCss:{"border-bottom":"1px solid "+ludo.$C("border")}},{name:"selected",layout:{height:25},css:{"font-weight":"bold","line-height":"25px","padding-left":"2px"}}]},show:function(a,b){this.parent();if(a&&a.pgn_id){this.child.list.getDataSource().selectRecord({id:a.pgn_id})}else{if(b){this.child.list.getDataSource().selectRecord({id:b.id})}}}});chess.wordpress.UpdateGameButton=new Class({Extends:ludo.form.Button,submodule:"wordpress.updategame",value:chess.__("Update"),setController:function(a){this.parent(a);a.on("game",this.onNewGame.bind(this))},onNewGame:function(){}});chess.wordpress.MetadataTitle=new Class({Extends:chess.view.metadata.Game,submodule:"wordpress.metadatatitle",metadata:undefined,dirty:false,css:{"line-height":"120%"},tpl:function(f){f=f||this.metadata;if(!f){return}if(f&&(f.white||f.black)){var c=f.white?f.white:"?";var a=f.black?f.black:"?";var d="";if(f.id&&!isNaN(f.id)){d+='<div class="game_id">Game ID: '+f.id+"</div>"}d+=c+" vs "+a+" "+f.result;if(this.dirty){d+="<sup>*</sup>"}if(f.pgn){d+='<br><span style="font-size:0.7em">PGN: '+f.pgn+"</span>"}return d}this.metadata=f},setController:function(a){this.parent(a);this.controller.on("clean",this.setClean.bind(this));this.controller.on("dirty",this.setDirty.bind(this));this.controller.on("updateMetadata",this.updateMetadata.bind(this))},setClean:function(){this.dirty=false;this.updateMetadata(this.controller.currentModel)},setDirty:function(){this.dirty=true;this.updateMetadata(this.controller.currentModel)}});chess.wordpress.WordPressMessage=new Class({Extends:ludo.View,css:{"text-align":"right","padding-right":"5px",color:"#EF9A9A","font-weight":"normal","font-size":"12px","line-height":"25px"},submodule:"wordpress.wordpressmessage",autoHideDelay:3000,startTime:undefined,__rendered:function(){this.parent();this.els.message=jQuery('<div style="position:absolute;right:5px"></div>');this.$b().append(this.els.message)},setController:function(a){this.parent(a);a.on("wperror",this.showError.bind(this));a.on("wpmessage",this.showMessage.bind(this))},showError:function(a){this.$b().css("color","#EF9A9A");this.els.message.html(a);this.animateIn();this.autoHide()},showMessage:function(a){this.$b().css("color","#AED581");this.els.message.html(a);this.animateIn();this.autoHide()},autoHide:function(){this.startTime=new Date().getTime();this.autoHideComplete.delay(this.autoHideDelay,this)},animateIn:function(){var a=this.els.message;a.css("top",this.$b().height());a.animate({top:0},{duration:200})},animateOut:function(){this.els.message.animate({top:this.$b().height()},{duration:200})},autoHideComplete:function(){var a=new Date().getTime()-this.startTime;if(a>=this.autoHideDelay){this.animateOut()}}});chess.wordpress.UndoRedo=new Class({Extends:Events,maxSize:50,stack:undefined,current:undefined,model:undefined,fn:undefined,t:0,initialize:function(a){this.model=a;this.stack=[];if(jQuery.isPlainObject(a.model)){this.model.on("dirty",this.add.bind(this))
}this.add(a)},listen:function(){jQuery(document).keydown(function(f){var d=f.target.tagName.toLowerCase();if(f.target&&(d=="textarea"||d=="input")){return}if(f.ctrlKey||(f.key&&f.key=="Meta")||f.metaKey){var c=f.keyCode;var a=c==90&&this.hasUndo();var b=c==89&&this.hasRedo();if(c==90&&f.shiftKey){a=false;b=true}if(b){this.model.undoRedo(this.redo());f.stopPropagation();return false}else{if(a){this.model.undoRedo(this.undo());f.stopPropagation();return false}}}}.bind(this))},hasUndo:function(){return this.current>0},hasRedo:function(){return this.current<this.stack.length-1},isModel:function(a){return jQuery.type(a)=="object"},isEqualToNext:function(a){if(!this.hasRedo()){return false}return this.isEqualTo(a,this.stack[this.current+1])},isEqualTo:function(b,a){if(this.isModel(b)){return a.fen==b.fen()}else{return b==a}},getModelForHistory:function(b){var a=Object.clone(b.getCurrentMove());return{model:Object.clone(b.model),currentMove:a,fen:b.fen()}},add:function(b){var a=new Date().getTime();if(a-this.t<400){return}if(this.isEqualToNext(b)){this.current++;return}if(this.stack.length>0&&this.isEqualTo(b,this.stack[this.current])){this.stack[this.current]=this.getModelForHistory(b);return}this.stack.splice(this.current+1,this.maxSize);if(jQuery.type(b)=="object"){this.stack.push(this.getModelForHistory(b))}else{this.stack.push(b)}if(this.stack.length>this.maxSize){this.stack.shift()}this.current=this.stack.length-1;this.t=new Date().getTime()},undo:function(){if(this.current>0){return this.stack[--this.current]}},redo:function(){if(this.current<this.stack.length-1){return this.stack[++this.current]}},len:function(){return this.stack.length}});chess.wordpress.DiscardDraftButton=new Class({Extends:ludo.form.Button,submodule:"wordpress.discarddraft",value:chess.__("Discard"),setController:function(a){this.parent(a);a.on("dirty",this.toggle.bind(this));a.on("clean",this.toggle.bind(this))},toggle:function(){var a=this.controller.getCurrentModel();if(!a){return}var b=a.getMetadataValue("draft_id");if(!b){this.hide()}else{this.show()}}});chess.wordpress.NewDatabaseDialog=new Class({Extends:ludo.dialog.Dialog,submodule:"wordpress.newdatabasedialog",layout:{width:400,height:150,type:"linear",orientation:"vertical"},buttonConfig:"OkCancel",title:chess.__("New Game Database"),css:{padding:5},__children:function(){return[{type:"form.Label",labelFor:"dbName",label:chess.__("New Game Database")},{name:"dbname",type:"form.Text",placeholder:chess.__("Name of new database"),required:true,validateKeyStrokes:true,validator:function(a){return a.trim().length>=5}}]},__rendered:function(){this.parent();this.okButton=this.getButton("ok");this.okButton.disable();this.getForm().on("valid",function(){this.okButton.enable()}.bind(this));this.getForm().on("invalid",function(){this.okButton.disable()}.bind(this));this.on("ok",function(){this.fireEvent("newdatabase",this.child.dbname.val())})},show:function(){this.parent();this.child.dbname.select()}});chess.wordpress.GameList=new Class({Extends:ludo.dataSource.JSONArray,type:"chess.wordpress.GameList",autoload:false,singleton:true,resource:"Database",postData:{action:"list_of_games"},__construct:function(a){if(a.singleton!==undefined){this.singleton=a.singleton}this.url=ludo.config.getUrl();this.parent(a);this.sortFn=this.sortFn||{};this.sortFn.round={asc:function(d,c){return this.compareRound(d,c,1)}.bind(this),desc:function(d,c){return this.compareRound(d,c,0)}.bind(this)}},compareRound:function(d,c,g){var i=this.sortVal(d);var h=this.sortVal(c);var f=i<h?1:-1;if(!g){f*=-1}return f},sortVal:function(b){var a=b.round;if(!a){return 1}var c=a.split(/\./g);if(c.length==1){return parseInt(c[0])}return parseInt(c[0]*1000)+parseInt(c[1])},loadPgn:function(a){this.postData.pgn=a;this.sendRequest(this.service,a)}});chess.wordpress.PublishConfirmDialog=new Class({Extends:ludo.dialog.Confirm,autoremove:false,css:{padding:5}});chess.wordpress.DraftButton=new Class({Extends:ludo.form.Button,submodule:"wordpress.savedraft",__construct:function(a){a.value=chess.__("Save Draft");this.parent(a)},setController:function(a){this.parent(a)}});window.chess.isWordPress=true;chess.WPEditor=new Class({Extends:Events,renderTo:undefined,offset:undefined,initialize:function(c){this.renderTo=jQuery(c.renderTo);if(c.docRoot){ludo.config.setDocumentRoot(c.docRoot)}var a=jQuery(document.body);this.offset=jQuery("#wpwrap").offset().top-a.outerHeight()+a.height();this.onWinResize();this.module=String.uniqueID();jQuery(document).ready(this.render.bind(this));jQuery(window).on("resize",this.onWinResize.bind(this))},onWinResize:function(){this.renderTo.css("height",(jQuery(document.body).height()-this.offset))},render:function(){jQuery(document.body).addClass("ludo-twilight");this.renderTo.addClass("ludo-twilight");new chess.view.Chess({renderTo:jQuery(this.renderTo),layout:{type:"linear",orientation:"vertical",height:"matchParent",width:"matchParent"},children:[{layout:{type:"linear",orientation:"horizontal",weight:1},children:[{module:this.module,css:{overflow:"hidden"},submodule:"wordpress.dockinglayout",layout:{type:"docking",tabs:"left",width:300,resizable:true,minWidth:50},children:[{title:chess.__("Game Drafts"),id:"draftsDockingView",type:"FramedView",elCss:{"border-left-width":0},layout:{type:"fill"},children:[{type:"chess.wordpress.DraftListView",module:this.module,css:{padding:2},dataSource:{type:"chess.wordpress.Drafts"}}]},{type:"FramedView",layout:{type:"linear",orientation:"vertical",visible:true},elCss:{"border-left-width":0},title:chess.__("PGN Databases"),children:[{type:"form.Button",value:chess.__("New Database"),submodule:"chess.newDatabaseButton",module:this.module,layout:{width:"matchParent"}},{type:"chess.wordpress.PgnListView",module:this.module,layout:{weight:1}}]},{type:"FramedView",titleBar:{title:chess.__("Games"),module:this.module,buttons:[{type:"rename",title:chess.__("Rename Database"),icon:ludo.config.getDocumentRoot()+"/images/settings.png?rnd="+Math.random(),listener:function(){this.controller.renameDatabase()
}}]},module:this.module,submodule:"wordpress.gamelisttab",title:chess.__("Games"),elCss:{"border-left-width":0},layout:{type:"linear",orientation:"vertical"},children:[{type:"form.Text",placeholder:chess.__("Search"),id:"searchField",layout:{height:30},listeners:{key:function(a){ludo.$("gamelistgrid").getDataSource().search(a)}},elCss:{"border-bottom":"1px solid "+ludo.$C("border")}},{id:"gamelistgrid",type:"chess.wordpress.GameListGrid",module:this.module,layout:{weight:1}},{layout:{height:30,type:"linear",orientation:"horizontal"},css:{"padding-top":2},elCss:{"border-bottom":"1px solid "+ludo.$C("border")},children:[{weight:1},{type:"paging.First",dataSource:"editor_game_list_ds",layout:{width:35}},{type:"paging.Previous",dataSource:"editor_game_list_ds",layout:{width:35}},{type:"paging.CurrentPage",dataSource:"editor_game_list_ds"},{type:"paging.TotalPages",dataSource:"editor_game_list_ds"},{type:"paging.Next",dataSource:"editor_game_list_ds",layout:{width:35}},{type:"paging.Last",dataSource:"editor_game_list_ds",layout:{width:35}},{weight:1}]},{elCss:{"padding-top":2},layout:{type:"linear",orientation:"horizontal",height:30},children:[{type:"form.Button",module:this.module,value:chess.__("Standings"),submodule:"wordpress.standingsbutton",listeners:{rendered:function(){if(!this.controller.pgn){this.hide()}}}},{type:"form.Button",module:this.module,value:chess.__("Import PGN"),submodule:"wordpress.importpgn",listeners:{rendered:function(){if(!this.controller.pgn){this.hide()}}}}]}]}]},{layout:{weight:1,type:"linear",orientation:"vertical"},css:{"border-left":"1px solid "+ludo.$C("border")},children:[{type:"chess.wordpress.EditorHeading",module:this.module,layout:{height:20}},{module:this.module,type:"chess.wordpress.MetadataTitle",css:{"text-align":"center"},layout:{height:45}},{type:"chess.view.board.Board",module:this.module,layout:{weight:1},squareStyles_white:{"background-color":"#a3a3a3"},squareStyles_black:{"background-color":"#888888"},elCss:{"margin-top":5,"margin-bottom":2},background:{borderRadius:ludo.isMobile?"0.5%":"1%",paint:{fill:"#1a2026"}},pieceLayout:"svg_darkgrey",labelOddStyles:ludo.isMobile?{color:"#fff"}:{color:"#fff"},labelEvenStyles:{color:"#fff"},labels:!ludo.isMobile,padding:ludo.isMobile?"1%":"3%",labelPos:ludo.isMobile?"inside":"outside",plugins:[{type:"chess.view.highlight.Arrow",styles:{fill:"#f77cc5",stroke:"#888"}},{type:"chess.view.highlight.ArrowTactic",styles:{fill:"#f77cc5",stroke:"#888"}},{type:"chess.view.highlight.SquareTacticHint"}]},{type:"chess.view.buttonbar.Bar",elCss:{"border-bottom":"1px solid "+ludo.$C("border")},layout:{height:40},buttonSize:function(a){return a*0.8},module:this.module,borderRadius:"10%",styles:{button:{fill:"#666",stroke:"#bbb"},image:{fill:"#ccc"},buttonOver:{fill:"#777",stroke:"#a3a3a3"},imageOver:{fill:"#eee"},buttonDown:{fill:"#555",stroke:"#bbb"},imageDown:{fill:"#bbb"},buttonDisabled:{fill:"#888","fill-opacity":0.4,stroke:"#888"},imageDisabled:{fill:"#555","fill-opacity":0.4}}},{elCss:{"border-top":"1px solid "+ludo.$C("border")},layout:{type:"tabs",tabs:"top",height:jQuery(document.body).height()/4,resizable:true,resizePos:"above"},children:[{title:"Notations",type:"chess.view.notation.Panel",showEval:true,module:this.module,figurines:"svg_bw",showContextMenu:true},{type:"chess.wordpress.CommentView",title:chess.__("Annotate"),module:this.module},{title:chess.__("Computer Eval"),type:"wordpress.ComputerEval",module:this.module,layout:{}},{title:chess.__("Metadata"),module:this.module,type:"chess.wordpress.GameMetadata"}]},{elCss:{"border-top":"1px solid "+ludo.$C("border")},module:this.module,type:"chess.wordpress.WordPressMessage",layout:{height:20},css:{"line-height":"20px"}}]}]},{layout:{height:35,type:"linear",orientation:"horizontal"},css:{padding:4,"background-color":ludo.$C("border")},children:[{module:this.module,submodule:"wordpress.newgame",type:"form.Button",value:chess.__("New Game"),layout:{width:80}},{module:this.module,submodule:"wordpress.newposition",type:"form.Button",value:chess.__("New Position"),layout:{width:120}},{layout:{weight:1,height:25}},{type:"chess.wordpress.UpdateGameButton",module:this.module,layout:{width:80}},{module:this.module,hidden:true,type:"chess.wordpress.DiscardDraftButton",layout:{width:80}},{type:"chess.wordpress.PublishButton",module:this.module,layout:{width:80}},{type:"chess.wordpress.DraftButton",module:this.module,layout:{width:80}}]}]});this.controller=new chess.wordpress.WordpressController({applyTo:[this.module],garboChess:ludo.config.getDocumentRoot()+"/garbochess/js/garbochess.js"})}});chess.wordpress.DiscardDraftDialog=new Class({Extends:ludo.dialog.Confirm,submodule:"wordpress.discarddraftdialog",title:chess.__("Discard draft"),_html:chess.__("Are you sure you want to discard this draft?"),buttonConfig:"YesNo",autoRemove:false,layout:{width:300,height:150},resizable:false,modal:true});chess.wordpress.DraftListView=new Class({Extends:ludo.ListView,dataSource:{type:"chess.wordpress.Drafts"},emptyText:chess.__("No Drafts Found"),submodule:"wordpress.draftlist",__construct:function(a){a.loadMessage=chess.__("Loading drafts...");
this.parent(a)},__rendered:function(){this.parent();this.getDataSource().on("select",this.selectGame.bind(this))},setController:function(a){this.parent(a);a.on("draftsupdated",function(){this.getDataSource().load()}.bind(this))},itemRenderer:function(a){return'<div style="border-radius:5px;padding:4px;border:1px solid '+ludo.$C("border")+'"><strong>'+a.title+'</strong></div><div style="text-align:right;font-size:0.8em">'+chess.__("Last updated")+" "+a.updated+"</div>"},selectGame:function(a){this.fireEvent("selectDraft",a.game)}});chess.wordpress.NotationPanel=new Class({Extends:chess.view.notation.Panel,setController:function(a){this.parent(a);a.on("fen",this.showMoves.bind(this))}});chess.wordpress.PgnListView=new Class({Extends:ludo.ListView,swipable:true,submodule:"wordpress.pgnlistview",emptyText:chess.__("No Databases found"),idToSelect:undefined,itemRenderer:function(a){return'<div class="pgn_list_item"><div class="pgn_list_name"><strong>'+a.pgn_name+'</strong></div><div class="pgn_list_pgn_id">ID: '+a.id+'</div><div class="pgn_list_count_games">Games: '+a.count+'</div><div class="pgn_list_updated">Updated: '+a.updated+"</div></div>"},__rendered:function(){this.parent();this.getDataSource().on("load",function(){if(this.idToSelect){this.getDataSource().selectRecord({id:this.idToSelect})}}.bind(this))},backSideLeft:function(){return'<div style="position:absolute;top:50%;margin-top:-10px;left:10px">'+chess.__("Archive Database")+"</div>"},backSideUndo:function(){return'<div style="position:absolute;top:50%;margin-top:-10px;left:10px">'+chess.__("Undo")+"</div>"},__construct:function(a){this.dataSource={type:"chess.wordpress.PgnList",listeners:{select:this.selectPgn.bind(this)}};this.parent(a);this.on("swipe",function(b){jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"archive_pgn",pgn:b.id},complete:function(c,f){if(f){var d=c.responseJSON;if(d.success){this.getDataSource().remove(b);this.controller.sendMessage(chess.__("PGN archived"))}else{this.controller.sendError("Unable to Archive: "+d.response);this.undoSwipe(b)}}else{this.controller.sendError(c.responseText);this.undoSwipe(b)}}.bind(this)})}.bind(this))},setController:function(a){this.parent(a);a.on("publish",function(){this.getDataSource().load()}.bind(this));a.on("new_pgn",function(b){this.idToSelect=b;this.getDataSource().load()}.bind(this));a.on("rename_pgn",function(){this.getDataSource().load()}.bind(this));a.on("imported",function(){this.getDataSource().load()}.bind(this))},selectPgn:function(a){this.fireEvent("selectpgn",a)}});chess.wordpress.ColorView=new Class({Extends:ludo.FramedView,colors:[],colorContainer:undefined,selectedColor:undefined,selectedEl:undefined,parentDialog:undefined,css:{padding:2},storageKey:undefined,userColors:undefined,__construct:function(a){this.parent(a);this.colors=a.colors;this.storageKey=a.storageKey;this.parentDialog=a.dialog},__rendered:function(){this.parent();this.colorContainer=jQuery('<div class="wpc-color-container"></div>').appendTo(this.$b());this.renderColors();this.$e.css("overflow","visible");this.$b().css("overflow","visible")},renderColors:function(){jQuery.each(this.colors,function(f,d){this.colorContainer.append(this.getColorBox(d,false))}.bind(this));this.colorContainer.append('<div style="clear:both">');this.userColors=this.colorsFromStorage();for(var c=0;c<10;c++){var b=this.userColors.length>c?this.userColors[c]:undefined;var a=this.getColorBox(b,true);a.data("userColorIndex",c);this.colorContainer.append(a)}},colorsFromStorage:function(){var a=localStorage.getItem(this.storageKey)||"[]";a=JSON.parse(a);return a},resize:function(a){this.parent(a)},getColorBox:function(a,c){var b=jQuery('<div class="wpc-color-box"></div>');if(a){b.css("background-color",a);b.attr("title",a)}else{b.addClass("wpc-color-box-empty")}if(c){b.addClass("wpc-color-box-custom");b.attr("title","Click to add color")}b.data("color",a);b.on("click",this.selectColor.bind(this));return b},updateColor:function(a){},selectColor:function(c){var b=jQuery(c.target);var a=b.data("color");if(b.hasClass("wpc-color-box-empty")){this.editColor(b);return}if(this.selectedEl){this.selectedEl.removeClass("wpc-color-box-selected")}if(a===this.selectedColor){this.selectedColor=undefined;this.fireEvent("deselect");if(b.hasClass("wpc-color-box-custom")){this.editColor(b)}}else{b.addClass("wpc-color-box-selected");this.selectedColor=a;this.fireEvent("select",a);this.selectedEl=b}},editColor:function(b){var a=b.data("color")||"";var c=this.editColorView();c.showWith(b,"above");c.setColor(a,b)},_editColorView:undefined,editColorView:function(){if(this._editColorView===undefined){this._editColorView=new chess.wordpress.ColorEditDialog({width:200,height:150,renderTo:this.parentDialog.$b(),listeners:{selectColor:this.onColorUpdate.bind(this)}})}return this._editColorView},onColorUpdate:function(a,c){c.css("background-color",a);c.data("color",a);c.attr("title",a);c.removeClass("wpc-color-box-empty");var b=c.data("userColorIndex");
this.userColors[b]=a;localStorage.setItem(this.storageKey,JSON.stringify(this.userColors))},clear:function(){if(this.selectedEl){this.selectedEl.removeClass("wpc-color-box-selected")}this.selectedColor=undefined;this.selectedEl=undefined}});chess.wordpress.FenBoard=new Class({Extends:chess.view.position.Board,mode:"insertPiece",curColor:undefined,curArrow:undefined,addBoardEvents:function(){this.els.board.on("mousedown",this.onMouseDown.bind(this));this.els.board.on("mouseup",this.onMouseUp.bind(this));this.els.board.on("click",this.onBoardClick.bind(this));this.els.board.on("mousemove",this.onBoardMove.bind(this));jQuery(document.body).on("mouseup",this.onMouseUp.bind(this));this.els.board.on("mouseup",this.onBoardMove.bind(this));this.addEvent("resetboard",this.sendFen.bind(this));this.addEvent("modifyboard",this.sendFen.bind(this));this.addEvent("clearboard",this.sendFen.bind(this));this.addEvent("render",this.sendFen.bind(this))},lastArrowSquare:undefined,onMouseUp:function(c){if(this.mode==="arrowMove"){var b=this.getSquareByEvent(c);var a=Board0x88Config.numberToSquareMapping[b];if(a===this.curArrow.from){this.arrowPool().removeArrow(this.curArrow)}else{this.arrowPool().update(this.curArrow,a)}this.mode="arrowStart"}this.lastArrowSquare=undefined},onBoardMove:function(c){if(this.mode==="arrowMove"){var b=this.getSquareByEvent(c);if(b!==this.lastArrowSquare){var a=Board0x88Config.numberToSquareMapping[b];this.lastArrowSquare=b;this.arrowPool().update(this.curArrow,a)}}},clearBoard:function(){this.parent();this.clearArrows();this.highlightPool().hideAll()},clearArrows:function(){this.arrowPool().hideAll()},addArrow:function(c,b,a){this.arrowPool().show(c,b,{fill:a,stroke:a})},highlightSquare:function(b,a){this.highlightPool().show(b,a)},onMouseDown:function(c){if(this.mode!=="arrowStart"){return}var b=this.getSquareByEvent(c);if(b===undefined){return}var a=Board0x88Config.numberToSquareMapping[b];this.curArrow=this.arrowPool().show(a,a,{fill:this.curColor,stroke:this.curColor});this.mode="arrowMove"},arrowString:function(){return this.arrowPool().toString()},highlightString:function(){return this.highlightPool().toString()},onBoardClick:function(c){var b=this.getSquareByEvent(c);if(b===undefined){return}var a=Board0x88Config.numberToSquareMapping[b];switch(this.mode){case"insertPiece":this.insertPiece(c);break;case"arrowStart":case"arrowMove":break;case"highlight":this.highlightPool().show(a,this.curColor);break}},startHighlight:function(a){this.mode="highlight";this.curColor=a},startArrowMode:function(a){this.mode="arrowStart";this.curColor=a},setMode:function(a){this.mode=a},clearMode:function(){this.mode="insertPiece"},highlightPool:function(){if(this._highlightPool===undefined){this._highlightPool=new chess.view.highlight.SquarePool({board:this,autoToggle:true})}return this._highlightPool},_arrowPool:undefined,arrowPool:function(){if(this._arrowPool===undefined){this._arrowPool=new chess.view.highlight.ArrowPool({board:this})}return this._arrowPool}});chess.wordpress.PublishButton=new Class({Extends:ludo.form.Button,submodule:"wordpress.publish",value:chess.__("Publish"),setController:function(a){this.parent(a);a.on("game",this.onNewGame.bind(this))},onNewGame:function(){}});chess.wordpress.GameListGrid=new Class({Extends:chess.view.gamelist.Grid,headerMenu:false,submodule:"wordpress.gamelist",dataSource:undefined,emptyText:chess.__("No games"),loadMessage:chess.__("Loading games..."),cols:["white","black","round","result","last_moves"],__construct:function(a){this.dataSource={id:"editor_game_list_ds",type:"ludo.dataSource.JSONArray",autoload:false,postData:{action:"list_of_games"},paging:{size:25}};this.parent(a)},__rendered:function(){this.parent();this.loadGames();this.on("show",this.loadGames.bind(this))},setController:function(a){this.parent(a);a.on("publish",function(){if(this.controller.pgn){this.getDataSource().load()}}.bind(this));a.on("imported",function(){if(this.controller.pgn){this.getDataSource().load()}}.bind(this))},loadGames:function(){if(this.controller){if(this.controller.pgn&&this.controller.pgn!==this.getDataSource().postData.pgn){this.load()}}else{if(this.getDataSource().postData.pgn){this.load()}}},load:function(){if(this.controller&&this.controller.pgn){this.getParent().setTitle(chess.__("PGN:")+" "+this.controller.pgn.pgn_name);this.getDataSource().postData.pgn=this.controller.pgn.id;this.getDataSource().load()}else{if(this.getDataSource().postData.pgn){this.getDataSource().load()}}},selectGame:function(a){this.fireEvent("selectGame",[a,this.getDataSource().postData.pgn])}});chess.wordpress.WordPressArchived=new Class({Extends:ludo.View,layout:{type:"linear",orientation:"vertical"},__children:function(){return[{type:"form.Text",placeholder:chess.__("Search"),listeners:{key:function(a){this.child.list.getDataSource().search(a)}.bind(this)}},{name:"list",type:"ListView",swipable:true,emptyText:chess.__("No archived databases"),dataSource:{type:"ludo.dataSource.JSONArray",autoload:true,postData:{action:"list_archived"}},itemRenderer:function(a){return'<div class="pgn_list_item"><div class="pgn_list_name"><strong>'+a.pgn_name+'</strong></div><div class="pgn_list_pgn_id">ID: '+a.id+'</div><div class="pgn_list_count_games">Games: '+a.count+'</div><div class="pgn_list_updated">Updated: '+a.updated+"</div></div>"
},backSideLeft:function(a){return'<div style="position:absolute;top:50%;margin-top:-10px;left:10px">'+chess.__("Restore")+"</div>"},backSideRight:function(a){return'<div style="text-align:right;position:absolute;top:50%;margin-top:-10px;right:10px">'+chess.__("Delete")+"</div>"},backSideUndo:function(a){return'<div style="position:absolute;top:50%;margin-top:-10px;left:10px">'+chess.__("Undo")+"</div>"},layout:{weight:1},css:{"border-bottom":"1px solid "+ludo.$C("border")}},{layout:{height:30},name:"message",type:"chess.wordpress.WordPressMessage"}]},__rendered:function(){this.parent();this.child.list.on("swipeLeft",this.deletePermanently.bind(this));this.child.list.on("swipeRight",this.restore.bind(this))},deletePermanently:function(a){jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"delete_pgn",pgn:a.id},complete:function(b,d){if(d){var c=b.responseJSON;if(c.success){this.child.list.remove(a);this.showMessage(chess.__("PGN deleted"))}else{this.showError(chess.__("Not able to delete"));this.child.list.undoSwipe(a)}}else{this.showError(b.responseText);this.child.list.undoSwipe(a)}}.bind(this)})},restore:function(a){jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"restore_pgn",pgn:a.id},complete:function(b,d){if(d){var c=b.responseJSON;if(c.success){this.child.list.getDataSource().remove(a);this.showMessage(chess.__("PGN restored"))}else{this.showError(chess.__("Not able to restore"));this.child.list.undoSwipe(a)}}else{this.showError(b.responseText);this.child.list.undoSwipe(a)}}.bind(this)})},showError:function(a){this.child.message.showError(a)},showMessage:function(a){this.child.message.showMessage(a)}});chess.wordpress.ColorEditDialog=new Class({Extends:chess.view.popup.View,color:undefined,cls:"wpc-color-edit-dialog",selectedEl:undefined,layout:{type:"linear",orientation:"vertical"},__construct:function(a){this.parent(a);this.color=a.color},__rendered:function(){this.parent();this.$b().css("padding",4)},setColor:function(a,b){this.selectedEl=b;ludo.$("wpc-color-preview").$b().css("background-color",a?a:"transparent");ludo.$("rgbcolor").val(a?a:"")},onBtnClick:function(){if(this.color){this.fireEvent("selectColor",[this.color,this.selectedEl])}this.hide()},onColorChange:function(a){var c=/^#[a-f0-9]{3}$/;var b=/^#[a-f0-9]{6}$/;if(c.test(a)||b.test(a)){this.color=a;ludo.$("wpc-color-preview").$b().css("background-color",a)}},__children:function(){return[{type:"form.Label",label:"Select color"},{name:"rgbcolor",type:"form.Text",maxLength:7,placeholder:"#RRGGBB",listeners:{key:this.onColorChange.bind(this)}},{id:"wpc-color-preview",css:{border:"1px solid #aaa","border-radius":"5px",overflow:"hidden","text-align":"center"},layout:{weight:1}},{layout:{type:"linear",orientation:"horizontal",height:30},css:{"padding-top":4},children:[{weight:1},{type:"form.Button",value:"Cancel",listeners:{click:this.hide.bind(this)}},{type:"form.Button",value:"OK",listeners:{click:this.onBtnClick.bind(this)}}]}]}});chess.wordpress.PgnParserView=new Class({Extends:ludo.View,submodule:"wordpress.pgnparserview",parser:undefined,__construct:function(a){this.parent(a);this.parser=new chess.pgn.Parser()},__rendered:function(){this.parent();this.on("show",this.updatePgn.bind(this))},setController:function(a){this.parent(a)},updatePgn:function(){var a=this.parser.getPgn(this.controller.currentModel);this.html(a.replace(/\n/g,"<br>"))}});chess.wordpress.EditorHeading=new Class({Extends:ludo.View,submodule:"wordpress.editorheading",css:{"font-size":"11px","font-style":"italic","text-align":"right",padding:"5px"},__rendered:function(){this.parent();this.getNumberOfGames()},setController:function(a){this.parent(a)},getNumberOfGames:function(){jQuery.post(ludo.config.getUrl(),{action:"count_games"},function(a){if(a.success){this.html(chess.__("Games in Database:")+" "+a.response)}}.bind(this))}});chess.wordpress.ImportPgnDialog=new Class({Extends:ludo.dialog.Dialog,autoRemove:false,pgn:undefined,layout:{type:"linear",orientation:"vertical"},__children:function(){return[{type:"form.Textarea",layout:{weight:1},name:"pgn_string",placeholder:chess.__("Paste your PGN here")},{name:"message",layout:{height:30},css:{"text-align":"right","padding-right":4}},{name:"buttonPanel",layout:{type:"linear",orientation:"horizontal",height:30},children:[{weight:1},{name:"importButton",type:"form.Button",value:chess.__("Import"),listeners:{click:this.importPgn.bind(this)}},{type:"form.Button",value:chess.__("Cancel"),listeners:{click:this.hide.bind(this)}}]}]},show:function(a){this.parent();this.child.message.html("");this.child.pgn_string.val("");this.pgn=a;this.setTitle(chess.__("Import into "+this.pgn.pgn_name));this.child.buttonPanel.child.importButton.setEnabled(true);this.shim().hide()},importPgn:function(){this.showMessage("");var a=this.child.pgn_string.val().trim();if(a.length>0){this.child.buttonPanel.child.importButton.setEnabled(false);this.shim().show("Importing");
jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"import_pgn_string",pgn_id:this.pgn.id,pgn:a},complete:function(d,c){this.child.buttonPanel.child.importButton.setEnabled(true);this.shim().hide();if(c=="success"){var f=d.responseJSON;if(f.success){var g=f.response;this.fireEvent("imported");this.child.pgn_string.val("");var b=chess.__("{0} of {1} games imported");b=b.replace("{0}",g.imported);b=b.replace("{1}",g.total);this.showMessage(chess.__(b))}else{this.showError(chess.__("Could not import pgn string"))}}else{this.showError(chess.__("Could not import pgn string"))}}.bind(this)})}else{this.showError(chess.__("A PGN String is required"))}},showError:function(a){this._message(a,"#EF9A9A")},showMessage:function(a){this._message(a,"#AED581")},_message:function(b,a){this.child.message.$b().css("color",a);this.child.message.html(b)}});chess.wordpress.PositionDialog=new Class({Extends:ludo.dialog.Dialog,submodule:"positionSetup",autoRemove:false,autoHideOnBtnClick:false,width:670,height:550,title:chess.__("Fen Setup"),layout:{type:"relative"},selectedPiece:undefined,closable:true,minimizable:false,resizable:false,positionValidator:undefined,position:{board:"",color:"w",castling:"KQkq",enPassant:"-",halfMoves:"0",fullMoves:"0"},colors:["#ff0000","#00ff00","#B71C1C","#66BB6A","#29B6F6","#FB8C00","#7B1FA2","#303F9F","#1976D2","#0097A7"],boardId:"boardContainer",controller:undefined,module:"wpc-pos-dialog",_curTheme:"grey",__construct:function(a){a=a||{};if(a.theme){this._curTheme=a.theme}this.positionValidator=new chess.parser.PositionValidator();a.buttonBar={align:"left",children:[{value:"OK",listeners:{click:this.sendPosition.bind(this)}},{weight:1},{value:"Reset",css:{"font-weight":"normal"},listeners:{click:this.resetBoard.bind(this)}},{value:"Clear board",listeners:{click:this.clearBoard.bind(this)}},{value:"Load fen",listeners:{click:this.showLoadFenDialog.bind(this)}},{value:"Clear Arrows",listeners:{click:function(){this.boardView().clearArrows()}.bind(this)}},{value:"Flip",listeners:{click:this.flipBoard.bind(this)}},{value:"Cancel",listeners:{click:this.hide.bind(this)}}]};this.parent(a)},__children:function(){return[{id:"boardChessView",type:"chess.view.Chess",layout:{alignParentLeft:true,alignParentTop:true,width:380,height:380,type:"fill"},children:[{type:"chess.wordpress.FenBoard",id:this.boardId,autoResize:false,pieceLayout:"svg_darkgrey",background:{borderRadius:ludo.isMobile?"0.5%":"1%",paint:{fill:"#1a2026"}},layout:{},padding:"3%",elCss:{margin:3},listeners:{setPosition:this.receivePosition.bind(this),clickSquare:this.onClickSquare.bind(this)},plugins:[{type:"chess.view.highlight.Arrow",styles:{fill:"#f77cc5",stroke:"#888"}},{type:"chess.view.highlight.ArrowTactic",styles:{fill:"#f77cc5",stroke:"#888"}},{type:"chess.view.highlight.SquareTacticHint"}]}]},{layout:{type:"tabs",tabs:"top",rightOf:"boardChessView",alignParentTop:true,fillRight:true,height:380},elCss:{"border-top":"1px solid #ccc"},css:{border:"1px solid #ccc","border-top":"none","padding-top":2},children:[{title:"Setup",layout:{type:"relative"},children:[{type:"chess.view.position.Pieces",id:"whitePieces",layout:{height:"matchParent",width:55,type:"linear",orientation:"vertical",top:4,fillDown:true},pieceColor:"white",listeners:{selectpiece:this.selectPiece.bind(this)}},{type:"chess.view.position.Pieces",id:"blackPieces",width:55,pieceColor:"black",listeners:{selectpiece:this.selectPiece.bind(this)},elCss:{"padding-right":4},layout:{top:4,height:"matchParent",rightOf:"whitePieces",type:"linear",orientation:"vertical"}},{id:"castling",type:"chess.view.position.Castling",listeners:{change:this.receiveCastling.bind(this)},layout:{top:4,rightOf:"blackPieces",width:150,height:145}},{id:"sideToMove",type:"chess.view.position.SideToMove",listeners:{change:this.receiveColor.bind(this)},layout:{sameWidthAs:"castling",height:100,below:"castling",alignLeft:"castling"}},{id:"moveNumberContainer",children:[{id:"moveNumber",type:"form.Label",labelFor:"moveNumber",label:chess.__("Ply"),value:1},{id:"moveNumber",name:"moveNumber",type:"form.Number",minValue:1,maxValue:500,required:true,value:"1",listeners:{change:this.receiveFullMoves.bind(this)}}],layout:{type:"table",columns:[{weight:1},{width:40}],below:"sideToMove",sameWidthAs:"sideToMove",alignLeft:"sideToMove",height:25}},{children:[{type:"form.Label",labelFor:"enPassant",label:chess.__("En passant")},{id:"positionEnPassant",type:"form.Text",name:"enPassant",maxLength:1,required:false,stretchField:false,validateKeyStrokes:true,regex:/[a-h]/g,listeners:{change:this.receiveEnPassant.bind(this)}}],layout:{type:"table",columns:[{weight:1},{width:40}],below:"moveNumberContainer",sameWidthAs:"moveNumberContainer",alignLeft:"moveNumberContainer",height:25}}]},{title:"Analysis",type:"chess.wordpress.ComputerEval",id:"compEval",layout:{height:470,width:"matchParent",type:"linear",orientation:"vertical"},listeners:{start:function(){if(this.isCurFenValid()){var a=this.getPosition();
ludo.$("compEval").fen=a;this.controller.currentModel.setPosition(a);this.controller.startEngine()}else{ludo.$("compEval").stopEngine()}}.bind(this),stop:function(){this.controller.stopEngine()}.bind(this)}}]},{layout:{below:"boardChessView",type:"linear",orientation:"horizontal",fillDown:true,width:"matchParent"},css:{},children:[{id:"highlightColorView",layout:{weight:1,height:"matchParent"},type:"chess.wordpress.ColorView",storageKey:"wpc-highlight-colors",title:"Highlight Squares",dialog:this,colors:this.colors,listeners:{select:function(a){this.boardView().startHighlight(a);ludo.$("arrowColorView").clear()}.bind(this),deselect:function(){this.boardView().clearMode()}.bind(this)}},{width:5},{id:"arrowColorView",layout:{weight:1,height:"matchParent"},type:"chess.wordpress.ColorView",title:"Arrows",colors:this.colors,dialog:this,storageKey:"wpc-arrow-colors",listeners:{select:function(a){this.boardView().startArrowMode(a);ludo.$("highlightColorView").clear()}.bind(this),deselect:function(){this.boardView().clearMode()}.bind(this)}}]}]},highlightColor:undefined,boardView:function(){return ludo.$(this.boardId)},onClickSquare:function(a){},__rendered:function(){this.parent();this.$b().addClass("dc-"+this._curTheme);this.$b().addClass("dc-admin-pos-dialog");this.board=ludo.$("boardContainer");this.moveNumber=ludo.$("moveNumber");this.controller=new chess.controller.StockfishEngineController({examine:false,applyTo:this.module,stockfish:ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js",listeners:{engineupdate:this.onEngineUpdate.bind(this)}})},onEngineUpdate:function(a){ludo.$("compEval").receiveEngineUpdate(a)},receiveCastling:function(a){this.updatePosition("castling",a)},receiveColor:function(a){this.updatePosition("color",a)},receiveEnPassant:function(a){a=a||"-";this.updatePosition("enPassant",a)},receiveFullMoves:function(a){a=a||"0";this.updatePosition("fullMoves",a)},receivePosition:function(a){this.updatePosition("board",a);this.position.board=a},updatePosition:function(a,b){this.position[a]=b;this.toggleOkButton()},isCurFenValid:function(){return this.positionValidator.isValid(this.getPosition())},toggleOkButton:function(){var a=this.getButton("ok");if(this.isCurFenValid()){if(a){a.enable()}}else{if(a){a.disable()}}},getPosition:function(){var a=this.position;return a.board+" "+a.color+" "+a.castling+" "+a.enPassant+" "+a.halfMoves+" "+a.fullMoves},clearBoard:function(){this.board.clearBoard()},resetBoard:function(){this.board.resetBoard();ludo.$("castling").resetOptions();ludo.$("sideToMove").resetOptions();ludo.$("moveNumber").val("1");ludo.$("positionEnPassant").val("")},sendPosition:function(){var a={fen:this.getPosition(),arrows:this.boardView().arrowString(),highlight:this.boardView().highlightString()};this.fireEvent("setPosition",a);this.hide()},flipBoard:function(){this.board.flip()},selectPiece:function(a){ludo.$("highlightColorView").clear();ludo.$("arrowColorView").clear();this.boardView().clearMode();ludo.$("whitePieces").clearSelections();ludo.$("blackPieces").clearSelections();if(this.selectedPiece&&this.selectedPiece.pieceType===a.pieceType&&this.selectedPiece.color===a.color){this.selectedPiece=undefined;this.board.deleteSelectedPiece()}else{this.selectedPiece=a;ludo.$(a.color+"Pieces").addSelection(a.pieceType);this.board.setSelectedPiece(a)}},showLoadFenDialog:function(){new ludo.dialog.Prompt({layout:{width:400,height:140,centerIn:this.$e},css:{padding:4},resizable:false,html:chess.__("Paste fen into the text box below"),inputConfig:{stretchField:true},modal:true,label:chess.__("FEN"),title:chess.__("Load fen"),listeners:{ok:this.loadFen.bind(this)}})},loadFen:function(a){if(this.isValidFen(a)){this.positionValidator.setFen(a);ludo.$("sideToMove").setColor(this.positionValidator.getColor());ludo.$("castling").val(this.positionValidator.getCastle());ludo.$("moveNumber").val(this.positionValidator.getFullMoves());ludo.$("positionEnPassant").val(this.positionValidator.getEnPassantSquare());this.board.showFen(a)}},isValidFen:function(a){try{parser=new chess.parser.FenParser0x88(a);parser.getValidMovesAndResult()}catch(b){new ludo.Notification({html:chess.__("Invalid Fen")});return false}return true},showPositionDialog:function(c,b,j,d,g){b=b||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";this.boardView().clearBoard();var h=b.split(/\s/g);this.position={board:h[0],color:h[1],castling:h.length>1?h[2]:"",enPassant:h.length>2?h[3]:"",halfMoves:h.length>3?h[4]:"",fullMoves:h.length>4?h[5]:""};this.toggleOkButton();var a=c.offset();this.showAt(a.left-20,a.top+20);if(b){this.loadFen(b)}if(j){var i=j.split(/,/g);i.forEach(function(l){var m=l.split(/;/);if(/^[a-h][1-8][a-h][1-8]$/.test(m[0])){var k=m.length===2&&this.isColor(m[1])?m[1]:"#ff0000";this.boardView().addArrow(m[0].substr(0,2),m[0].substr(2,2),k)}}.bind(this))}if(d){var f=d.split(/,/g);f.forEach(function(l){var m=l.split(/;/);if(/^[a-h][1-8]$/.test(m[0])){var k=m.length===2&&this.isColor(m[1])?m[1]:"#ff0000";this.boardView().highlightSquare(m[0],k)
}}.bind(this))}this.$b().removeClass("dc-"+this._curTheme);this._curTheme=g;this.$b().addClass("dc-"+g)},isColor:function(a){var c=/^#[a-f0-9]{3}$/;var b=/^#[a-f0-9]{6}$/;return c.test(a)||b.test(a)}});chess.wordpress.GameMetadata=new Class({Extends:ludo.View,submodule:"wordpress.gameMetadata",layout:{type:"table",simple:true,rowHeight:25,columns:[{width:100},{weight:1}]},css:{padding:4},__rendered:function(){this.parent();this.getForm().on("change",this.update.bind(this));this.on("show",this.populateForm.bind(this))},setController:function(a){this.parent(a);a.on("newGame",this.populateForm.bind(this));a.on("loadGame",this.populateForm.bind(this))},populateForm:function(){this.getForm().clear();this.getForm().populate(this.controller.currentModel.getMetadata())},update:function(a,b){this.fireEvent("metadata",[a,b])},__children:function(){return[{type:"form.Label",label:chess.__("White")+"* :",labelFor:"white"},{type:"form.Text",name:"white",placeholder:"White Player"},{type:"form.Label",label:chess.__("Black")+"* :",labelFor:"black"},{type:"form.Text",name:"black",placeholder:"Black Player"},{type:"form.Label",label:chess.__("Result")+":",labelFor:"result"},{type:"form.Select",dataSource:{url:undefined,data:["*","1-0","1/2-1/2","0-1"]},name:"result"},{type:"form.Label",label:chess.__("Event")+" :",labelFor:"event"},{type:"form.Text",name:"event",placeholder:"Event"},{type:"form.Label",label:chess.__("Date")+":",labelFor:"date"},{type:"form.Text",name:"date",placeholder:"Date"},{type:"form.Label",label:chess.__("Round")+":",labelFor:"round"},{type:"form.Text",name:"round",placeholder:"Round"}]}});chess.wordpress.PgnStandings=new Class({submodule:"wordpress.pgnstandings",Extends:ludo.grid.Grid,currentPgn:undefined,dataSource:undefined,headerMenu:false,sofiaRules:false,pgnId:undefined,highlightRecord:false,__columns:function(){return{player:{heading:chess.__("Player"),sortable:true,width:200,key:"player"},w:{heading:chess.__("Wins"),sortable:true,width:50},d:{heading:chess.__("Draw"),sortable:true,width:50},l:{heading:chess.__("Loss"),sortable:true,width:50},score:{heading:chess.__("Score"),sortable:true,renderer:function(b,a){if(this.sofiaRules){return(a.w*3)+a.d}return a.w+(a.d/2)}.bind(this)}}},__construct:function(a){this.dataSource={type:"dataSource.JSONArray",autoload:false,postData:{action:"get_standings"}};this.parent(a);this.__params(a,["sofiaRules","pgnId"])},__rendered:function(){this.parent();this.getDataSource().setSortFn("score",{desc:function(d,c){var g=d.w+(d.d/2);var f=c.w+(c.d/2);return g<f?1:-1},asc:function(d,c){var g=d.w+(d.d/2);var f=c.w+(c.d/2);return g<f?-1:1}});this.getDataSource().on("load",this.autoSort.bind(this));this.on("show",this.updateStandings.bind(this));if(this.pgnId){this.getDataSource().setPostParam("pgn",this.pgnId);this.getDataSource().load()}},setController:function(a){this.parent(a);a.on("pgn",this.setPgn.bind(this))},setPgn:function(a){if(a!=this.currentPgn){this.currentPgn=a}this.updateStandings()},autoSort:function(){this.getDataSource().by("score").descending().sort()},updateStandings:function(){if(!this.currentPgn){return}if(this.controller&&this.controller.pgn&&this.controller.pgn.id!=this.currentPgn){return}this.getDataSource().setPostParam("pgn",this.currentPgn);this.getDataSource().load()}});chess.ThemeBuilder=new Class({json:undefined,css:undefined,initialize:function(b,a){this.json=b;this.css=a;this.validateBranch(this.json)},validateBranch:function(a){jQuery.each(a,function(c,d){var b=jQuery.type(d);if(b==="object"){this.validateBranch(d)}else{if(b==="array"){if(d.length===0){a[c]={}}}}}.bind(this))},mergeJSON:function(a){this.json=Object.merge(this.json,a)},set:function(b,d){if(b=="chess.view.board.Board/labelStyles/color"){this.set("chess.view.board.Board/labelOddStyles",undefined);this.set("chess.view.board.Board/labelEvenStyles",undefined)}var c=this.findJSONArray(b);if(c){var a=this.getKey(b);if(!isNaN(d)){d/=1}c[a]=d}},setCss:function(a,b,c,d){if(c=="px"){d+="px"}if(!this.css){this.css={}}if(!this.css[a]){this.css[a]={}}this.css[a][b]=d},getKey:function(a){return a.split(/\//g).pop()},findJSONArray:function(a){var c=a.split(/\//g);c.pop();var b=this.json;c.forEach(function(d){if(b&&b[d]!==undefined){b=b[d]}else{b=undefined}});return b},cssString:function(){var a=[];jQuery.each(this.css,function(b,c){jQuery.each(c,function(d,f){if(f.indexOf("images")>=0){f="url("+f+")";f=f.replace("[DOCROOT]",ludo.config.getDocumentRoot())}a.push(".dc-custom "+b+"{"+d+":"+f+" !important }")})});return a.join("")}});chess.wordpress.CommentView=new Class({Extends:ludo.View,submodule:"wordpress.CommentView",layout:{type:"linear",orientation:"vertical",width:"matchParent",height:"matchParent"},currentLabel:"",currentComment:"",currentMove:undefined,notification:undefined,__children:function(){return[{name:"top",layout:{type:"linear",orientation:"horizontal",height:30},css:{"padding-top":2},children:[{name:"move",css:{"font-weight":"bold","padding-left":"4px","line-height":"30px"},layout:{weight:1},html:this.currentLabel},{type:"form.Button",value:"!",layout:{width:30}},{type:"form.Button",value:"?",layout:{width:30}},{type:"form.Button",value:"!!",layout:{width:30}},{type:"form.Button",value:"??",layout:{width:30}},{type:"form.Button",value:"?!",layout:{width:30}},{type:"form.Button",value:"!?",layout:{width:30}},{type:"form.Button",name:"clear",value:chess.__("Clear")}]},{type:"form.Textarea",placeholder:chess.__("Enter Comment"),name:"comment",layout:{weight:1},listeners:{key_up:this.saveComment.bind(this)}}]
},__rendered:function(){this.parent();this.on("show",this.updateViews.bind(this));this.getForm().on("btnClick",this.onBtnClick.bind(this))},onBtnClick:function(a,b){if(this.currentMove){if(a=="clear"){this.controller.currentModel.gradeMove(this.currentMove,"")}else{this.controller.currentModel.gradeMove(this.currentMove,b)}this.updateHeading()}},setController:function(a){this.parent(a);a.on("fen",this.update.bind(this));a.on("newGame",this.update.bind(this));a.on("startOfGame",this.update.bind(this));a.on("dirty",this.update.bind(this))},onNewGame:function(){},saveComment:function(){if(this.currentMove){this.controller.addCommentAfter(this.child.comment.val(),this.currentMove)}else{this.controller.currentModel.setGameComment(this.child.comment.val())}},update:function(b){if(!b){b=this.controller.currentModel}var a=b.getCurrentMove();if(!a&&b.model.moves.length>0&&b.model.moves[0].comment){a=b.model.moves[0]}if(a==this.currentMove){return}this.currentMove=a;this.updateHeading();if(this.children.length){this.child.comment.val("");this.child.comment.val(this.currentComment)}},updateHeading:function(){if(!this.currentMove){this.currentLabel=chess.__("Game Comment")}else{this.currentLabel=chess.__("Annotate")+" "+this.currentMove.m;this.currentComment=this.currentMove.comment}if(this.children.length){this.child.top.child.move.html(this.currentLabel)}},updateViews:function(){if(this.children.length){this.child.top.child.move.html(this.currentLabel);if(this.currentComment){this.child.comment.val(this.currentComment)}}}});chess.wordpress.Drafts=new Class({Extends:ludo.dataSource.JSONArray,submodule:"wordpress.drafts",postData:{action:"list_drafts"}});chess.wordpress.WordpressController=new Class({Extends:chess.controller.StockfishEngineController,posSetup:undefined,newGameDialog:undefined,__construct:function(a){a.stockfish=ludo.config.getDocumentRoot()+"/stockfish-js/stockfish.js";this.parent(a);this.currentModel.setClean();this.currentModel.on("dirty",this.fireDirty.bind(this));this.currentModel.on("clean",this.fireClean.bind(this));this.updateButtonVisibility();this.setDefaultMetadata();this.currentModel.setClean();var b=new chess.wordpress.UndoRedo(this.currentModel);b.listen();this.autoSaveDraft.delay(15000,this);this.listenForSave();jQuery(window).on("beforeunload",this.confirmLeave.bind(this));this.addKeyEvents()},addKeyEvents:function(){jQuery(document).keydown(function(a){if(a.key=="ArrowRight"){this.currentModel.nextMove();return false}else{if(a.key=="ArrowLeft"){this.currentModel.previousMove();return false}}}.bind(this))},confirmLeave:function(){if(this.currentModel.isDirty()){return chess.__("You have unsaved changed. ")}},listenForSave:function(){jQuery(document).keydown(function(c){if(!this.currentModel){return}var a=c.ctrlKey||(c.key&&c.key=="Meta")||c.metaKey;if(c.keyCode==83&&a){var b=this.currentModel.getMetadataValue("id");if(b&&!isNaN(b)){this.saveUpdates()}else{this.saveDraft()}return false}}.bind(this))},fireDirty:function(){this.fireEvent("dirty")},fireClean:function(){this.fireEvent("clean")},addView:function(a){success=this.parent(a);if(success){switch(a.submodule){case"wordpress.importpgn":this.views.importPgnButton=a;a.on("click",this.importPgnString.bind(this));break;case"wordpress.standingsbutton":this.views.standingsButton=a;a.on("click",this.showStandings.bind(this));break;case"wordpress.newposition":a.on("click",this.showPositionSetup.bind(this));break;case"wordpress.position":a.on("setPosition",this.onNewPositionClick.bind(this));break;case"wordpress.savedraft":this.views.saveDraftButton=a;a.on("click",this.saveDraft.bind(this));break;case"wordpress.gameMetadata":a.on("metadata",this.updateMetadata.bind(this));this.views.metadata=a;break;case"wordpress.pgnlistview":a.on("selectpgn",this.selectPgn.bind(this));break;case"wordpress.gamelist":this.views.gamelist=a;a.on("selectGame",this.selectGame.bind(this));break;case"wordpress.gamelisttab":this.views.gamelisttab=a;break;case"wordpress.dockinglayout":this.views.docking=a;break;case"wordpress.draftlist":this.views.draftlist=a;a.on("selectDraft",this.selectGame.bind(this));break;case"wordpress.publish":this.views.publishButton=a;a.on("click",this.publishGame.bind(this));break;case"wordpress.discarddraft":this.views.discardDraftButton=a;a.on("click",this.discardDraft.bind(this));break;case"wordpress.updategame":this.views.updateGameButton=a;a.on("click",this.saveUpdates.bind(this));break;case"wordpress.newgame":a.on("click",this.onNewGameClick.bind(this));break;case"chess.newDatabaseButton":a.on("click",this.showNewDatabaseDialog.bind(this));this.views.newDatabaseButton=a;break;case"wordpress.newdatabasedialog":a.on("newdatabase",this.createDatabase.bind(this));break;case"wordpress.computereval":a.on("appendLine",this.appendLine.bind(this));break;case"notation":this.views.notations=a;break}}},renameDatabase:function(){if(!this.pgn){this.showError(chess.__("No database selected"))}else{this.getDatabaseRenameDialog().show(this.pgn)}},getDatabaseRenameDialog:function(){if(this.renameDbDialog===undefined){this.renameDbDialog=new chess.wordpress.RenameDatabaseDialog({layout:{centerIn:this.views.board},listeners:{renameDatabase:this.finishRename.bind(this)}})
}return this.renameDbDialog},finishRename:function(b,a){if(a.trim().length==0){this.showError("Invalid name");return}jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:{action:"rename_pgn",pgn:b.id,name:a},complete:function(c,f){if(f){var d=c.responseJSON;if(d.success){this.fireEvent("wpmessage",chess.__("Database Renamed"));this.fireEvent("rename_pgn");this.views.gamelisttab.setTitle(d.response.name)}else{this.fireEvent("wperror",d.response)}}else{this.fireEvent("wperror",c.responseText)}}.bind(this)})},appendLine:function(a){var b=this.currentModel.appendLine(a,true);if(b){this.views.notations.show()}},getDiscardDraftDialog:function(){if(this.discardDraftDialog==undefined){this.discardDraftDialog=new chess.wordpress.DiscardDraftDialog({listeners:{yes:this.discardDraftConfirmed.bind(this)},layout:{centerIn:this.views.board}})}return this.discardDraftDialog},discardDraft:function(){this.getDiscardDraftDialog().show()},discardDraftConfirmed:function(){this.disableButtons();jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:{action:"discard_draft",draft_id:this.currentModel.getMetadataValue("draft_id")},complete:function(a,c){this.enableButtons();if(c){var b=a.responseJSON;if(b.success){this.fireEvent("wpmessage",chess.__("Draft discarded"));this.fireEvent("draftsupdated");this.currentModel.newGame()}else{this.fireEvent("wperror",b.response)}}else{this.fireEvent("wperror",a.responseText)}}.bind(this)})},newGameFen:undefined,setDefaultMetadata:function(){this.currentModel.setMetadata({white:chess.__("Player White"),black:chess.__("Player Black"),date:new Date().format("%x"),result:"*"})},getNewGameDialog:function(){if(this.newGameDialog==undefined){this.newGameDialog=new ludo.dialog.Confirm({html:chess.__("You have unsaved game data. Do you want to discard these?"),autoRemove:false,css:{padding:5},buttonConfig:"YesNo",layout:{centerIn:this.views.board,width:300,height:200},listeners:{yes:function(){this.currentModel.newGame();this.setDefaultMetadata();if(this.newGameFen){this.currentModel.setPosition(this.newGameFen)}this.updateButtonVisibility()}.bind(this),no:function(){}}})}return this.newGameDialog},importPgnString:function(){if(this.importPgnWindow==undefined){this.importPgnWindow=new chess.wordpress.ImportPgnDialog({title:chess.__("Import PGN"),layout:{left:100,top:100,width:400,height:500},listeners:{imported:function(){this.fireEvent("imported")}.bind(this)}})}this.importPgnWindow.show(this.pgn)},showStandings:function(){if(this.standingsWindow===undefined){this.standingsWindow=new ludo.dialog.Dialog({title:chess.__("Standings"),autoRemove:false,layout:{type:"fill",left:100,top:100,width:500,height:400},buttonConfig:"Ok",children:[{type:"chess.wordpress.PgnStandings",module:this.module}]})}this.standingsWindow.setTitle(chess.__("Standings")+" - "+this.pgn.pgn_name);this.standingsWindow.children[0].setPgn(this.pgn.id);this.standingsWindow.show()},onNewPositionClick:function(a){this.newGameFen=a;if(this.currentModel.isDirty()){this.getNewGameDialog().show()}else{this.currentModel.setDefaultModel();this.currentModel.setPosition(a);this.updateButtonVisibility();this.views.metadata.show()}},showNewDatabaseDialog:function(){if(!this.newDbDialog){this.newDbDialog=new chess.wordpress.NewDatabaseDialog({module:this.module,autoRemove:false});this.addView(this.newDbDialog)}this.newDbDialog.show();var b=this.views.newDatabaseButton.getEl().offset();var a=this.views.newDatabaseButton.getEl().outerHeight();this.newDbDialog.showAt(b.left,b.top+a)},createDatabase:function(a){jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"new_pgn",pgn_name:a},complete:function(b,d){if(d){var c=b.responseJSON;this.enableButtons();if(c.response){if(c.success){this.fireEvent("new_pgn",c.response);this.fireEvent("wpmessage",chess.__("New Database created"))}else{this.fireEvent("wpmessage",chess.__(e.response))}}}else{this.fireEvent("wperror",b.responseText)}}.bind(this)})},onNewGameClick:function(){this.newGameFen=undefined;if(this.currentModel.isDirty()){this.getNewGameDialog().show()}else{this.currentModel.newGame();this.setDefaultMetadata();this.updateButtonVisibility();this.views.metadata.show()}},getPublishDialog:function(){if(this.publishDialog==undefined){this.publishDialog=new chess.wordpress.PublishDialog({autoRemove:false,layout:{centerIn:this.views.board},listeners:{selectpgn:function(b){this.publish_pgn=b;var a=this.getPublishConfirmDialog();a.show();a.html(chess.__("Publish game in")+" <strong>"+this.publish_pgn.pgn_name+"</strong>?")}.bind(this)}});this.addView(this.publishDialog)}return this.publishDialog},getPublishConfirmDialog:function(){if(this.publishConfirmDialog==undefined){this.publishConfirmDialog=new ludo.dialog.Confirm({html:"",autoRemove:false,css:{padding:5},buttonConfig:"YesNo",layout:{centerIn:this.views.board,width:300,height:200},listeners:{yes:function(){this.publishComplete(this.publish_pgn)}.bind(this),no:function(){this.hide()
}}})}return this.publishConfirmDialog},publishGame:function(){var a=this.validateAndReturnModel();if(!a){return}this.getPublishDialog().show(this.currentModel.getMetadata(),this.pgn)},publishComplete:function(b){this.currentModel.setMetadata({pgn_id:b.id});var a=this.validateAndReturnModel();if(!a){return}this.disableButtons();jQuery.ajax({url:ludo.config.getUrl(),method:"post",dataType:"json",cache:false,data:{action:"publish_game",game:JSON.stringify(a),pgn:b.id},complete:function(c,f){if(f){var d=c.responseJSON;this.enableButtons();if(d.response){if(d.success){this.currentModel.draft_id=undefined;this.fireEvent("wpmessage",chess.__("Game published"));this.fireEvent("draftsupdated");this.fireEvent("publish");this.currentModel.setMetadata({draft_id:undefined});this.currentModel.setMetadata({id:d.response});this.currentModel.setMetadata({pgn_id:b.id});this.currentModel.setClean();this.updateButtonVisibility()}else{this.fireEvent("wpmessage",chess.__("Everything is up to date"))}}}else{this.fireEvent("wperror",c.responseText)}}.bind(this)})},selectPgn:function(a){if(this.views.standingsButton){this.views.standingsButton.show()}if(this.views.importPgnButton){this.views.importPgnButton.show()}this.pgn=a;this.fireEvent("pgn",a);if(this.views.gamelisttab){this.views.gamelisttab.show();if(this.views.gamelist){this.views.gamelist.loadGames()}}},gameToLoad:undefined,getConfirmDialog:function(){if(this.confirmDialog==undefined){this.confirmDialog=new ludo.dialog.Confirm({html:chess.__("You have unsaved game data. Do you want to discard these?"),autoRemove:false,css:{padding:5},buttonConfig:"YesNo",layout:{centerIn:this.views.board,width:300,height:200},listeners:{yes:function(){this.loadPgn(this.gameToLoad);this.gameToLoad=undefined}.bind(this),no:function(){this.gameToLoad=undefined;this.hide()}}})}return this.confirmDialog},selectGame:function(a){if(this.currentModel.isDirty()){this.gameToLoad=a;this.getConfirmDialog().show();return}this.loadPgn(a)},loadPgn:function(a){if(a.pgn_id&&a.id){this.load({action:"game_by_id",pgn:a.pgn_id,id:a.id})}else{if(a.draft_id){this.load({action:"get_draft",draft_id:a.draft_id})}}},load:function(a){this.disableButtons();this.currentModel.beforeLoad();jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,dataType:"json",data:a,complete:function(d,b){this.currentModel.afterLoad();this.enableButtons();if(b=="success"){var f=d.responseJSON;if(f.success){if(this.views.docking){this.views.docking.getLayout().collapse()}var c=f.response;this.currentModel.populate(c);this.currentModel.setClean();this.updateButtonVisibility();this.fireEvent("game",c)}}else{this.fireEvent("wperrror",chess.__("Could not load game. Try again later"))}}.bind(this),fail:function(c,b){this.fireEvent(b)}.bind(this)})},updateButtonVisibility:function(){var a=this.currentModel.getMetadata();this.views.updateGameButton.hide();this.views.publishButton.hide();this.views.saveDraftButton.hide();this.views.discardDraftButton.toggle();if(a.pgn_id){this.views.updateGameButton.show()}else{this.views.publishButton.show();this.views.saveDraftButton.show()}},updateMetadata:function(a,b){if(this.currentModel){this.currentModel.setMetadataValue(a,b)}},deleteDraft:function(a){},saveUpdates:function(){var a=this.currentModel.modelForServer();if(!a){return}if(!a.white||!a.black){this.fireEvent("wperror","Metadata missing");this.views.metadata.show();return}this.disableButtons();jQuery.ajax({url:ludo.config.getUrl(),method:"post",cache:false,data:{action:"save_game",pgn:a.pgn_id,game:JSON.stringify(a)},complete:function(b,d){this.enableButtons();if(d){var c=b.responseJSON;if(c.success){this.fireEvent("wpmessage",chess.__("Game Saved"));this.fireEvent("publish");this.currentModel.setClean()}else{this.fireEvent("wpmessage",chess.__(c.response))}}}.bind(this)})},isModelValidForSave:function(){var a=this.currentModel.modelForServer();if(!a){return false}return(a.white&&a.black)},validateAndReturnModel:function(b){var a=this.currentModel.modelForServer();if(!a){return false}if(!a.white||!a.black){if(!b){this.fireEvent("wperror","Metadata missing");this.views.metadata.show()}return false}if(a.id&&isNaN(a.id)){a.id=undefined}delete a.metadata;return a},autoSaveDraft:function(){var c=this.currentModel.getMetadataValue("id");var b=!c||isNaN(c);if(b&&this.currentModel.model.moves.length>0){var a=this.validateAndReturnModel(true);if(a){this.saveDraft()}}this.autoSaveDraft.delay(30000,this)},saveDraft:function(){var a=this.validateAndReturnModel();if(!a){return}this.disableButtons();jQuery.ajax({url:ludo.config.getUrl(),dataType:"json",method:"post",data:{action:"save_draft",game:JSON.stringify(a)},complete:function(b,d){this.enableButtons();if(d){var c=b.responseJSON;if(c.success){this.fireEvent("wpmessage",chess.__("Draft Saved"));this.fireEvent("draftsupdated");this.currentModel.setMetadata({draft_id:c.response.draft_id});this.currentModel.setClean()}else{this.fireEvent("wpmessage",chess.__("Everything is up to date"))}}else{this.fireEvent("wperror",b.responseText)
}}.bind(this)})},sendMessage:function(a){this.fireEvent("wpmessage",a)},sendError:function(a){this.fireEvent("wperror",a)},disableButtons:function(){this.views.saveDraftButton.setEnabled(false);this.views.publishButton.setEnabled(false)},enableButtons:function(){this.views.saveDraftButton.enable.delay(1000,this.views.saveDraftButton);this.views.publishButton.enable.delay(1000,this.views.publishButton)},showPositionSetup:function(){if(this.posSetup==undefined){this.posSetup=new chess.view.position.Dialog({submodule:"wordpress.position",layout:{centerIn:this.views.board},listeners:{setPosition:this.receiveNewPosition.bind(this)}});this.posSetup.on("setPosition",this.onNewPositionClick.bind(this))}this.posSetup.show()},receiveNewPosition:function(a){this.currentModel.setPosition(a)}});chess.wordpress.ComputerEval=new Class({Extends:ludo.View,submodule:"wordpress.computereval",started:false,fen:undefined,layout:{type:"linear",orientation:"vertical"},parser:undefined,bestLine:undefined,bestLineString:undefined,currentEval:undefined,buttons:true,appendBtn:true,showNodes:true,__children:function(){return[{name:"scoreBar",css:{margin:5},type:"chess.view.score.Bar",layout:{height:60},borderRadius:5,blackColor:"#444444",whiteColor:"#EEEEEE",markerColor:"#B71C1C",markerTextColor:"#FFF",stroke:"#222222",range:3},{name:"eval",layout:{weight:1},css:{padding:4}},{name:"buttons",layout:{height:30,type:"linear",orientation:"horizontal"},children:[{name:"startStopEngine",value:chess.__("Start"),type:"form.Button"},{visible:this.appendBtn&&!this.hideButton,name:"appendLine",value:chess.__("Append Line"),type:"form.Button"},{visible:this.appendBtn,name:"appendEval",value:chess.__("Save Eval"),type:"form.Button"},{layout:{weight:1},css:{"text-align":"right","font-style":"italic","font-size":"0.9em","padding-right":"4px"},html:'<a href="https://github.com/nmrugg/stockfish.js" onclick="var w = window.open(this.href); return false">'+chess.__("StockFish.JS Engine")+"</a>"}]}]},hideButton:false,__construct:function(a){this.parent(a);this.parser=new chess.parser.FenParser0x88();if(a.buttons!==undefined){this.buttons=a.buttons}if(a.appendBtn!==undefined){this.appendBtn=a.appendBtn}if(a.hideButton!==undefined){this.hideButton=a.hideButton}if(a.showNodes!==undefined){this.showNodes=a.showNodes}this.bestLine=[]},setController:function(a){this.parent(a);a.on("engineupdate",this.receiveEngineUpdate.bind(this));a.on("fen",this.onPositionUpdate.bind(this));a.on("instructorFen",this.onPositionUpdate.bind(this));a.on("newGame",this.clearView.bind(this))},receiveEngineUpdate:function(g){if(g.mate){var b=g.mate<0?-100:100;this.child.scoreBar.setScore(b);g.score="Mate in "+Math.abs(g.mate)}else{this.child.scoreBar.setScore(g.score)}this.currentEval=g.score;this.bestLineString=g.bestMoves;var d=g.depth;var c=g.nps;var f=g.score>0?"+":"";var a=this.showNodes?"<br>Nodes/s: "+c:"";this.child["eval"].html("Depth: "+d+a+'<br><div class="dhtml-chess-comp-eval"><span class="dhtml-chess-comp-eval-score">'+f+g.score+"</span> "+this.getMoveLine(g)+"</div>")},clearView:function(){if(this.child["eval"]){this.child["eval"].html("");this.child.scoreBar.setScore(0)}this.bestLineString="";this.bestLine=[];if(this.child.buttons&&this.buttons){this.child.buttons.child.appendLine.hide();this.child.buttons.child.appendEval.hide()}},getMoveLine:function(g){try{this.parser.setFen(this.fen);var h=g.bestMoves.split(/\s/g);this.bestLine=[];var n=g.currentPly;n+=2;var w='<span class="dhtml-chess-comp-eval-mn">';var l='<span class="dhtml-chess-comp-eval-notation">';var d=ludo.config.getDocumentRoot()+"/images/svg_bw45";var o=n%2==1?(w+".. "+Math.floor(n/2)+". </span>"):"";this.bestLine.push(o);var u=n;for(var k=0;k<h.length;k++){if(u%2==0){if(k>0){this.bestLine.push("</span>")}this.bestLine.push('<span class="dhtml-chess-comp-eval-group">');this.bestLine.push(w+(u/2)+". </span>")}var b=h[k];var p=b.substr(0,2);var v=b.substr(2,2);var j={from:p,to:v};if(b.length==5){j.promoteTo=b.substr(4,1)}this.parser.move(j);var s=this.parser.getNotation();if(/[QRBN]/.test(s.substr(0,1))){var r=u%2==0?"w":"b";this.bestLine.push('<img style="vertical-align:text-bottom;height:18px" src="'+d+r+s.substr(0,1).toLocaleLowerCase()+'.svg">');s=l+s.substr(1)+"</span>"}else{s=l+s+"</span>"}this.bestLine.push(s);u++}this.bestLine.push("</span>")}catch(q){this.stopEngine(true);this.startEngine.delay(200,this)}return this.bestLine.join(" ")},__rendered:function(){this.parent();this.on("hide",this.stopEngine.bind(this));var a=this.child.buttons;a.child.startStopEngine.on("click",this.toggleEngine.bind(this));a.child.appendLine.on("click",this.appendLine.bind(this));a.child.appendEval.on("click",this.appendEval.bind(this));a.child.appendLine.hide();a.child.appendEval.hide();if(this.hideButton){a.hide()}},appendEval:function(){this.controller.getCurrentModel().setEval(this.currentEval)},appendLine:function(){if(this.bestLineString){if(this.started){this.stopEngine()}this.fireEvent("appendLine",this.bestLineString)
}},onPositionUpdate:function(b,a){this.fen=a;this.parser.setFen(a);this.bestLine=[];if(this.started){this.stopEngine(true);this.startEngine.delay(200,this)}},toggleEngine:function(){if(this.started){this.stopEngine()}else{this.startEngine()}},stopEngine:function(a){if(!this.started){return}this.child.buttons.child.startStopEngine.val("Start");this.started=false;if(!this.controller){this.fireEvent("stop");return}this.controller.stopEngine();if(!a){this.controller.sendMessage(chess.__("Engine stopped"))}},startEngine:function(){this.child.buttons.child.startStopEngine.val("Stop");this.started=true;if(!this.controller){this.fireEvent("start");return}this.controller.startEngine();if(this.buttons){this.child.buttons.child.appendLine.show();this.child.buttons.child.appendEval.show()}}});